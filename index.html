<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalkulator PIO</title>

  <!-- PWA meta -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <!-- Ikonice za iOS -->
  <link rel="apple-touch-icon" href="icon-192.png">
</head>
<body>
<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Penzioni Kalkulator PIO - Srbija</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- DODAT: AutoTable plugin za PDF tabele -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* SVI STILOVI IZ PRVE APLIKACIJE + POBOLJ≈†ANJA */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
        }
        
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #f5f7fa;
            --dark: #34495e;
            --gray: #95a5a6;
            --border: #e0e0e0;
            --shadow: 0 3px 10px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }
        
        body { 
            background: var(--light); 
            min-height: 100vh; 
            padding: 20px;
            transition: var(--transition);
        }
        
        body[data-theme="dark"] {
            background: #121212;
            color: #e0e0e0;
        }
        
        body[data-theme="dark"] .card {
            background: #1e1e1e;
            color: #e0e0e0;
            border-color: #333;
        }
        
        body[data-theme="dark"] .header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
        }
        
        body[data-theme="dark"] input,
        body[data-theme="dark"] select,
        body[data-theme="dark"] textarea {
            background: #2d2d2d;
            color: #e0e0e0;
            border-color: #444;
        }
        
        body[data-theme="dark"] .data-table th {
            background: linear-gradient(to bottom, #2d2d2d, #3d3d3d);
            color: #e0e0e0;
        }
        
        body[data-theme="dark"] .data-table tr:hover {
            background: #2d2d2d;
        }
        
        body[data-theme="dark"] .data-table tr:nth-child(even) {
            background: #252525;
        }
        
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
        }
        
        /* HEADER SA TEME TOGGLE */
        .header { 
            background: linear-gradient(135deg, var(--primary) 0%, #4a6491 100%);
            color: white; 
            padding: 25px; 
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
            position: relative;
        }
        .header h1 { 
            font-size: 2.2rem; 
            margin-bottom: 10px; 
        }
        
        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .theme-toggle {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition);
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: rotate(30deg);
        }
        
        /* BREADCRUMB NAVIGACIJA */
        .breadcrumb {
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow);
            flex-wrap: wrap;
        }
        
        body[data-theme="dark"] .breadcrumb {
            background: #1e1e1e;
            color: #e0e0e0;
        }
        
        .breadcrumb-item {
            color: var(--secondary);
            cursor: pointer;
            font-weight: 500;
            padding: 4px 8px;
            border-radius: 4px;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .breadcrumb-item:hover {
            background: #e3f2fd;
        }
        
        body[data-theme="dark"] .breadcrumb-item:hover {
            background: #2d2d2d;
        }
        
        .breadcrumb-separator {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* POBOLJ≈†ANE KARTICE */
        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid var(--border);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card-hover {
            transition: var(--transition);
        }
        
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        /* POBOLJ≈†ANI TABOVI */
        .tabs {
            display: flex;
            border-bottom: 2px solid var(--border);
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 5px;
            position: relative;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            border-bottom: 3px solid transparent;
            transition: var(--transition);
            position: relative;
            white-space: nowrap;
        }
        
        .tab:hover { 
            color: var(--primary); 
            background: #f8f9fa;
            border-radius: 6px 6px 0 0;
        }
        
        body[data-theme="dark"] .tab:hover {
            background: #2d2d2d;
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--secondary);
        }
        
        .tab-indicator {
            position: absolute;
            bottom: -2px;
            height: 3px;
            background: var(--secondary);
            transition: left 0.3s ease, width 0.3s ease;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active { 
            display: block; 
        }
        
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* POBOLJ≈†AN HEADER */
        h2 { 
            color: var(--primary); 
            margin-bottom: 20px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid #f0f0f0; 
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        body[data-theme="dark"] h2 {
            color: #e0e0e0;
            border-bottom-color: #444;
        }
        
        h2:before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--secondary);
            border-radius: 2px;
        }
        
        h3 { 
            color: var(--dark); 
            margin: 15px 0 10px 0; 
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        body[data-theme="dark"] h3 {
            color: #e0e0e0;
        }
        
        /* POBOLJ≈†ANI FORME */
        .form-group { 
            margin-bottom: 20px; 
        }
        
        label {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        body[data-theme="dark"] label {
            color: #e0e0e0;
        }
        
        .tooltip-icon {
            cursor: help;
            color: var(--gray);
            font-size: 0.85rem;
            transition: var(--transition);
        }
        
        .tooltip-icon:hover {
            color: var(--secondary);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
            transition: var(--transition);
            background: white;
        }
        
        input:focus, select:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        /* POBOLJ≈†ANA DUGMAD */
        .btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        .btn:focus:not(:active)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }
            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-success:hover {
            background: #219653;
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-block {
            display: block;
            width: 100%;
            text-align: center;
            justify-content: center;
        }
        
        .btn-loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* POBOLJ≈†AN UPLOAD AREA */
        .upload-area {
            border: 2px dashed var(--secondary);
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #f8fafc;
            margin: 20px 0;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        body[data-theme="dark"] .upload-area {
            background: #2d2d2d;
        }
        
        .upload-area:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .upload-area:hover:before {
            left: 100%;
        }
        
        .upload-area:hover {
            border-color: #2980b9;
            background: #f0f7ff;
        }
        
        /* POBOLJ≈†AN STATUS SISTEM */
        .status {
            padding: 12px 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 14px;
            transition: var(--transition);
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        /* NOTIFIKACIONI SISTEM */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }
        
        .notification {
            background: white;
            border-radius: 8px;
            padding: 15px 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
            transform: translateX(400px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border-left: 4px solid var(--secondary);
        }
        
        body[data-theme="dark"] .notification {
            background: #1e1e1e;
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification-success {
            border-left-color: var(--success);
        }
        
        .notification-error {
            border-left-color: var(--danger);
        }
        
        .notification-info {
            border-left-color: var(--secondary);
        }
        
        .notification-warning {
            border-left-color: var(--warning);
        }
        
        .notification-icon {
            font-size: 1.2rem;
        }
        
        .notification-content {
            flex: 1;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }
        
        .notification-close:hover {
            background: #f8f9fa;
            color: var(--dark);
        }
        
        /* POBOLJ≈†AN RESULT BOX */
        .result-box {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            margin: 25px 0;
            position: relative;
            overflow: hidden;
        }
        
        .result-box:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.1;
            animation: float 20s linear infinite;
        }
        
        @keyframes float {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .penzija-iznos {
            font-size: 3rem;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }
        
        .penzija-mesecna {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 25px;
            opacity: 0.95;
            position: relative;
            z-index: 1;
        }
        
        /* POBOLJ≈†AN DETAILS GRID */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .detail-item {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 8px;
            text-align: left;
            transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.2);
            position: relative;
            z-index: 1;
        }
        
        .detail-item:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }
        
        .detail-item .label {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .detail-item .value {
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        /* POBOLJ≈†ANE TABLE */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid var(--border);
        }
        
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 0;
            font-size: 14px;
        }
        
        .data-table th {
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
            position: sticky;
            top: 0;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }
        
        .data-table th:hover {
            background: #e9ecef;
        }
        
        .data-table th.sort-asc:after {
            content: ' ‚Üë';
            font-size: 0.8em;
            color: var(--secondary);
        }
        
        .data-table th.sort-desc:after {
            content: ' ‚Üì';
            font-size: 0.8em;
            color: var(--secondary);
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }
        
        .data-table tr {
            transition: var(--transition);
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .data-table tr:nth-child(even) {
            background: #fafafa;
        }
        
        .data-table tr:nth-child(even):hover {
            background: #f0f0f0;
        }
        
        .money { 
            text-align: right; 
            font-family: 'Courier New', monospace; 
            font-weight: 600;
        }
        
        .actions-cell {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .actions-cell .btn {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        /* FORMULA DISPLAY - SKRIVEN */
        .formula-display {
            display: none;
        }
        
        /* INFO I WARNING BOX - SKRIVENI */
        .info-box, .warning-box {
            display: none;
        }
        
        /* FLEX GRID */
        .flex-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
            background: #fafafa;
            border-radius: 8px;
            border: 2px dashed var(--border);
        }
        
        body[data-theme="dark"] .empty-state {
            background: #2d2d2d;
            color: #aaa;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        /* CONFIG ROW */
        .config-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* USERS CONTAINER */
        .users-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 30px;
        }
        
        .users-sidebar {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border);
        }
        
        body[data-theme="dark"] .users-sidebar {
            background: #2d2d2d;
        }
        
        /* POBOLJ≈†AN USER ITEM */
        .user-item {
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .user-item:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .user-item:hover:before {
            left: 100%;
        }
        
        .user-item:hover {
            background: #edf2f7;
            border-color: var(--secondary);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.2);
        }
        
        body[data-theme="dark"] .user-item:hover {
            background: #3d3d3d;
        }
        
        .user-item.active {
            background: #e3f2fd;
            border-color: var(--secondary);
            box-shadow: 0 0 0 1px var(--secondary);
        }
        
        body[data-theme="dark"] .user-item.active {
            background: #3d3d3d;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--primary);
        }
        
        body[data-theme="dark"] .user-name {
            color: #e0e0e0;
        }
        
        .user-info {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        /* MANUAL EDIT AREA */
        .manual-edit-area {
            background: #f9f9f9;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        body[data-theme="dark"] .manual-edit-area {
            background: #2d2d2d;
        }
        
        .edit-row {
            display: grid;
            grid-template-columns: 100px 150px 150px 150px 150px auto;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: var(--transition);
        }
        
        body[data-theme="dark"] .edit-row {
            border-bottom-color: #444;
        }
        
        .edit-row:hover {
            background: #f5f5f5;
        }
        
        body[data-theme="dark"] .edit-row:hover {
            background: #3d3d3d;
        }
        
        .edit-row.header {
            font-weight: bold;
            background: #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        body[data-theme="dark"] .edit-row.header {
            background: #3d3d3d;
        }
        
        .small-text {
            font-size: 0.85rem;
            color: var(--gray);
        }
        
        /* USLOV CHECK */
        .uslov-check {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            font-weight: bold;
            transition: var(--transition);
        }
        
        .uslov-ispunjen {
            background: linear-gradient(to right, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .uslov-neispunjen {
            background: linear-gradient(to right, #f8d7da, #f5c6cb);
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .uslov-info {
            background: linear-gradient(to right, #d1ecf1, #bee5eb);
            color: #0c5460;
            border: 2px solid #bee5eb;
        }
        
        /* PROGRESS BAR */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #2ecc71);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg, 
                rgba(255, 255, 255, 0.2) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.2) 75%, 
                transparent 75%, 
                transparent
            );
            z-index: 1;
            background-size: 50px 50px;
            animation: move 2s linear infinite;
            border-radius: 10px;
        }
        
        @keyframes move {
            0% { background-position: 0 0; }
            100% { background-position: 50px 50px; }
        }
        
        /* STILOVI ZA PREDVIƒêANJE */
        .error {
            border-color: var(--danger) !important;
            background-color: #fdf2f2;
        }
        
        .error-message {
            color: var(--danger);
            font-size: 12px;
            margin-top: 5px;
            display: block;
        }
        
        .staz-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .staz-label {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            display: block;
        }
        
        body[data-theme="dark"] .staz-label {
            color: #e0e0e0;
        }
        
        .uslov-detalji {
            background: rgba(255,255,255,0.15);
            border-left: 4px solid var(--success);
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
            text-align: left;
        }
        
        .uslov-detalji h4 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .uslov-item {
            margin-bottom: 10px;
            padding-left: 10px;
            border-left: 2px solid rgba(255,255,255,0.3);
        }
        
        .uslov-ispunjen {
            color: #2ecc71;
            font-weight: 600;
        }
        
        .uslov-neispunjen {
            color: var(--danger);
        }
        
        .uslov-neutral {
            color: rgba(255,255,255,0.8);
        }
        
        /* RESPONSIVE POBOLJ≈†ANJA */
        @media (max-width: 1200px) {
            .users-container {
                grid-template-columns: 250px 1fr;
            }
        }
        
        @media (max-width: 992px) {
            .users-container {
                grid-template-columns: 1fr;
            }
            
            .users-sidebar {
                order: 2;
                margin-top: 20px;
            }
            
            .config-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8rem;
            }
            
            .penzija-iznos {
                font-size: 2.2rem;
            }
            
            .breadcrumb {
                padding: 10px 15px;
            }
            
            .tabs {
                overflow-x: auto;
                padding-bottom: 5px;
            }
            
            .tab {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .details-grid, .staz-row {
                grid-template-columns: 1fr;
            }
            
            .edit-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .notification-container {
                left: 20px;
                right: 20px;
                max-width: none;
            }
        }
        
        @media (max-width: 576px) {
            body {
                padding: 10px;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
                padding-right: 60px;
            }
            
            .header-controls {
                position: relative;
                top: 0;
                right: 0;
                justify-content: center;
                margin-top: 15px;
            }
            
            .card {
                padding: 15px;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .action-buttons .btn {
                flex: 1;
                min-width: 120px;
                justify-content: center;
            }
        }
        
        /* MOBILNI MENU ZA TABOVE */
        .mobile-tabs-toggle {
            display: none;
            background: var(--secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .mobile-tabs-toggle {
                display: flex;
            }
            
            .tabs {
                display: none;
                flex-direction: column;
                border: none;
                background: white;
                border-radius: 8px;
                box-shadow: var(--shadow);
                margin-bottom: 15px;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease;
            }
            
            body[data-theme="dark"] .tabs {
                background: #1e1e1e;
            }
            
            .tabs.show {
                display: flex;
                max-height: 500px;
            }
            
            .tab {
                border-bottom: 1px solid var(--border);
                border-radius: 0;
            }
            
            .tab:last-child {
                border-bottom: none;
            }
        }
        
        /* STILOVI ZA DROPDOWN MENU */
        .dropdown {
            position: relative;
            display: inline-block;
        }
        
        .dropdown-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: white;
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        body[data-theme="dark"] .dropdown-content {
            background-color: #2d2d2d;
            box-shadow: 0 8px 16px rgba(0,0,0,0.4);
        }
        
        .dropdown-content.show {
            display: block;
            animation: fadeInUp 0.2s ease;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .dropdown-item {
            display: block;
            padding: 12px 16px;
            text-decoration: none;
            color: var(--dark);
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        body[data-theme="dark"] .dropdown-item {
            color: #e0e0e0;
            border-bottom-color: #444;
        }
        
        .dropdown-item:hover {
            background-color: var(--light);
            color: var(--secondary);
        }
        
        body[data-theme="dark"] .dropdown-item:hover {
            background-color: #3d3d3d;
        }
        
        .dropdown-item:last-child {
            border-bottom: none;
        }
        
        .dropdown-icon {
            font-size: 14px;
            width: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- NOTIFIKACIONI SISTEM -->
        <div class="notification-container" id="notificationContainer"></div>
        
        <!-- HEADER SA TEME TOGGLE -->
        <div class="header">
            <h1>üèõÔ∏è Penzioni Kalkulator üèõÔ∏è  </h1>
            <p>Rezultati dobijeni u kalkulatoru su informativnog karaktera i ne mogu zameniti struƒçnu slu≈æbu PIO </p>
            
            <div class="header-controls">
                <button class="theme-toggle" id="themeToggle">üåô</button>
            </div>
        </div>
        
        <!-- BREADCRUMB NAVIGACIJA -->
        <div class="breadcrumb" id="breadcrumb">
            <span class="breadcrumb-item" data-tab="users">üë• Korisnici</span>
        </div>
        
        <!-- MOBILNI MENU TOGGLE -->
        <button class="mobile-tabs-toggle" id="mobileTabsToggle">
            <span>üìã Meni</span>
            <span id="mobileToggleIcon">‚ñº</span>
        </button>

        <!-- MAIN CARD -->
        <div class="card">
            <!-- TABS -->
            <div class="tabs" id="tabsContainer">
                <div class="tab active" data-tab="users">üë• Korisnici</div>
                <div class="tab" data-tab="excel">üìä Excel Import</div>
                <div class="tab" data-tab="calculation">üßÆ Rezultati Obraƒçuna</div>
                <div class="tab" data-tab="statistika">üìà Statistika Sta≈æa</div>
                <div class="tab" data-tab="predvidjanje">üìÖ Predviƒëanje Datuma</div>
                <div class="tab" data-tab="data">üìã Pregled Podataka</div>
                <div class="tab" data-tab="config">‚öôÔ∏è Pode≈°avanja</div>
            </div>
            
            <!-- TAB INDICATOR -->
            <div class="tab-indicator" id="tabIndicator"></div>

            <!-- USERS TAB -->
            <div class="tab-content active" id="users">
                <h2>Upravljanje korisnicima</h2>
                
                <div class="action-buttons">
                    <!-- DROPDOWN MENU ZA PDF UMESTO DUGMETA -->
                    <div class="dropdown" id="pdfDropdown">
                        <button class="btn btn-success dropdown-toggle">
                            üìÑ Generi≈°i PDF
                            <span style="font-size: 12px;">‚ñº</span>
                        </button>
                        <div class="dropdown-content" id="pdfDropdownContent">
                            <div class="dropdown-item" onclick="generisiKompletanPDF()">
                                <span class="dropdown-icon">üìã</span>
                                Kompletan PDF izve≈°taj
                            </div>
                            <div class="dropdown-item" onclick="generisiSa≈æetPDF()">
                                <span class="dropdown-icon">üìä</span>
                                Sa≈æetak (samo rezultati)
                            </div>
                            <div class="dropdown-item" onclick="generisiPDFZarade()">
                                <span class="dropdown-icon">üí∞</span>
                                Tabela zarada
                            </div>
                            <div class="dropdown-item" onclick="generisiPDFStaz()">
                                <span class="dropdown-icon">üìÖ</span>
                                Tabela sta≈æa
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="users-container">
                    <div class="users-sidebar card-hover">
                        <div class="form-group">
                            <label>Novi korisnik:</label>
                            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                                <input type="text" id="noviKorisnikIme" placeholder="Ime i prezime">
                                <button class="btn btn-success" id="dodajKorisnika">‚ûï Dodaj</button>
                            </div>
                        </div>
                        
                        <h3 style="margin-top: 30px;">Lista korisnika</h3>
                        <div id="listaKorisnika"></div>
                    </div>
                    
                    <div id="korisnikDetalji">
                        <div class="empty-state">
                            <div>üë§</div>
                            <p>Izaberite korisnika sa strane da biste videli detalje</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXCEL TAB -->
            <div class="tab-content" id="excel">
                <h2 id="excelNaslov">Uvoz podataka iz Excel fajla</h2>
                
                <div class="upload-area card-hover">
                    <h3>1. Izaberite Excel fajl</h3>
                    <input type="file" id="excelFile" accept=".xlsx, .xls" style="margin: 15px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                    <p class="small-text">Podr≈æani formati: .xlsx, .xls</p>
                    <div id="uploadStatus" class="status"></div>
                </div>
                
                <div class="config-row">
                    <div class="form-group">
                        <label for="godinaPenzionisanja">
                            üìÖ Godina penzionisanja:
                        </label>
                        <input type="number" id="godinaPenzionisanja" min="1990" max="2050" value="2024">
                    </div>
                    
                    <div class="form-group">
                        <label for="opstiBodValue">
                            üí∞ Op≈°ti bod za godinu penzionisanja (u dinarima):
                        </label>
                        <input type="number" id="opstiBodValue" min="0" step="0.01" value="1492.58">
                        <div class="small-text" style="color: #666; margin-top: 5px;">
                            Za 2024. godinu: <strong>1.492,58 dinara</strong>
                        </div>
                    </div>
                </div>
                
                <button id="obradiExcel" class="btn btn-success btn-block" disabled>
                    <span>üöÄ Obradi podatke i izraƒçunaj penziju</span>
                </button>
            </div>

            <!-- CALCULATION TAB -->
            <div class="tab-content" id="calculation">
                <h2>Rezultati obraƒçuna penzije</h2>
                
                <div class="result-box card-hover">
                    <h3>Va≈°a penzija</h3>
                    <div class="penzija-iznos" id="penzijaMesecno">0 RSD</div>
                    <div class="penzija-mesecna" id="penzijaGodisnje">0 RSD godi≈°nje</div>
                    
                    <div class="details-grid">
                        <div class="detail-item card-hover">
                            <div class="label">Liƒçni koeficijent</div>
                            <div class="value" id="licniKoeficijent">0.00</div>
                            <div class="small-text">(max 3.8)</div>
                        </div>
                        <div class="detail-item card-hover">
                            <div class="label">Koeficijent bolovanja</div>
                            <div class="value" id="koeficijentBolovanja">0.00</div>
                            <div class="small-text">(samo do 2002)</div>
                        </div>
                        <div class="detail-item card-hover">
                            <div class="label">Penzijski sta≈æ</div>
                            <div class="value" id="penzijskiStaz">0 godina</div>
                        </div>
                        <div class="detail-item card-hover">
                            <div class="label">Efektivni sta≈æ (za LK)</div>
                            <div class="value" id="efektivniStazZaKoeficijent">0 godina</div>
                        </div>
                        <div class="detail-item card-hover">
                            <div class="label">Op≈°ti bod</div>
                            <div class="value" id="opstiBodPrikaz">0.00 din</div>
                        </div>
                        <div class="detail-item card-hover">
                            <div class="label">Broj godina sa podacima</div>
                            <div class="value" id="brojGodina">0</div>
                        </div>
                    </div>
                </div>
                
                <!-- NOVO: USLOV 2/3 -->
                <div id="uslov23Container" style="display: none;">
                    <div class="card card-hover">
                        <h3>üîç Provera uslova 2/3 za beneficirani sta≈æ</h3>
                        <div id="uslov23Status" class="uslov-check"></div>
                        <div class="details-grid">
                            <div class="detail-item card-hover">
                                <div class="label">Ukupan efektivni sta≈æ</div>
                                <div class="value" id="uslovEfektivni">0 godina</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Ukupan beneficirani sta≈æ</div>
                                <div class="value" id="uslovBeneficirani">0 godina</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Zahtevani minimum (2/3)</div>
                                <div class="value" id="uslovMinimum">0 godina</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Ispunjenost uslova</div>
                                <div class="value" id="uslovProcenat">0%</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div id="uslovProgress" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card card-hover" style="margin-top: 20px;">
                    <h3>üìä Podaci za koeficijent bolovanja (period do 2002)</h3>
                    <div class="table-container">
                        <table class="data-table" id="tabelaBolovanje">
                            <thead>
                                <tr>
                                    <th>Godina</th>
                                    <th>Sati rada</th>
                                    <th>Sati bolovanja</th>
                                    <th>Godi≈°nji LK</th>
                                    <th>Doprinos</th>
                                </tr>
                            </thead>
                            <tbody id="tabelaBolovanjeBody">
                                <tr><td colspan="5" style="text-align: center;">Nema podataka za period do 2002</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="small-text" style="margin-top: 10px;">
                        * Koeficijent bolovanja se raƒçuna samo za period do 2002. godine (ukljuƒçujuƒái 2002)
                    </div>
                </div>
            </div>

            <!-- STATISTIKA TAB -->
            <div class="tab-content" id="statistika">
                <h2 id="statistikaNaslov">Statistika sta≈æa</h2>
                
                <!-- NOVO: USLOV 2/3 U STATISTICI -->
                <div id="statistikaUslovContainer" style="display: none; margin-bottom: 20px;"></div>
                
                <div id="statistikaContainer">
                    <div class="empty-state">
                        <div>üìä</div>
                        <p>Izaberite korisnika da biste videli statistiku sta≈æa</p>
                    </div>
                </div>
            </div>

            <!-- NOVI TAB: PREDVIƒêANJE DATUMA -->
            <div class="tab-content" id="predvidjanje">
                <h2>üìÖ Predviƒëanje Datuma Penzije</h2>
                
                <div class="action-buttons">
                    <button class="btn btn-success" id="preuzmiStazBtn">üìä Preuzmi sta≈æ iz statistike</button>
                </div>
                
                <div id="predvidjanjeStatus" class="status" style="display: none;"></div>
                
                <div class="form-section">
                    <div class="form-group">
                        <label for="predvidjanjeDatumRodjenja">
                            üìÖ Datum roƒëenja:
                        </label>
                        <input type="text" id="predvidjanjeDatumRodjenja" placeholder="dd.mm.gggg" required>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Format: dan.mesec.godina</div>
                    </div>
                    
                    <div class="form-group">
                        <span class="staz-label">üìä Efektivni sta≈æ (stvarno odraƒëeno):</span>
                        <div class="staz-row">
                            <div>
                                <label for="predvidjanjeEfektivniGodine">Godine:</label>
                                <input type="number" id="predvidjanjeEfektivniGodine" min="0" max="60" value="0">
                            </div>
                            <div>
                                <label for="predvidjanjeEfektivniMeseci">Meseci:</label>
                                <input type="number" id="predvidjanjeEfektivniMeseci" min="0" max="11" value="0">
                            </div>
                            <div>
                                <label for="predvidjanjeEfektivniDani">Dani:</label>
                                <input type="number" id="predvidjanjeEfektivniDani" min="0" max="30" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <span class="staz-label">üìä Beneficirani sta≈æ (rad pod beneficijom):</span>
                        <div class="staz-row">
                            <div>
                                <label for="predvidjanjeBeneficiraniGodine">Godine:</label>
                                <input type="number" id="predvidjanjeBeneficiraniGodine" min="0" max="60" value="0">
                            </div>
                            <div>
                                <label for="predvidjanjeBeneficiraniMeseci">Meseci:</label>
                                <input type="number" id="predvidjanjeBeneficiraniMeseci" min="0" max="11" value="0">
                            </div>
                            <div>
                                <label for="predvidjanjeBeneficiraniDani">Dani:</label>
                                <input type="number" id="predvidjanjeBeneficiraniDani" min="0" max="30" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="predvidjanjeVrstaBeneficije">
                            üéØ Vrsta beneficije:
                        </label>
                        <select id="predvidjanjeVrstaBeneficije">
                            <option value="12/12">12/12 - Bez beneficije</option>
                            <option value="12/14">12/14 - 2 meseca beneficije godi≈°nje</option>
                            <option value="12/15">12/15 - 3 meseca beneficije godi≈°nje</option>
                            <option value="12/16" selected>12/16 - 4 meseca beneficije godi≈°nje</option>
                            <option value="12/18">12/18 - 6 meseci beneficije godi≈°nje</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="predvidjanjeDatumPoslednjegRada">
                            üìÖ Datum poslednjeg rada:
                        </label>
                        <input type="text" id="predvidjanjeDatumPoslednjegRada" placeholder="dd.mm.gggg" required>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">Kada ste prestali da radite</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-success" id="predvidjanjeIzracunajBtn" style="padding: 15px 30px; font-size: 16px;">
                            üöÄ Izraƒçunaj predviƒëanje
                        </button>
                    </div>
                </div>
                
                <div id="predvidjanjeRezultati" style="display: none; padding: 25px;">
                    <div class="result-box card-hover">
                        <h3>üìä Rezultati predviƒëanja</h3>
                        <div class="penzija-iznos" id="predvidjanjePredvidjeniDatum">-</div>
                        <div style="font-size: 1.2rem; margin-bottom: 25px; opacity: 0.9;" id="predvidjanjePredvidjeniUslov"></div>
                        
                        <div class="details-grid">
                            <div class="detail-item card-hover">
                                <div class="label">Datum roƒëenja</div>
                                <div class="value" id="predvidjanjeRezDatumRodjenja">-</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Efektivni sta≈æ (na dan uslova)</div>
                                <div class="value" id="predvidjanjeRezEfektivniStaz">-</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Beneficirani sta≈æ (na dan uslova)</div>
                                <div class="value" id="predvidjanjeRezBeneficiraniStaz">-</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Ukupan sta≈æ (efektivni + beneficija)</div>
                                <div class="value" id="predvidjanjeRezUkupanStaz">-</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Vrsta beneficije</div>
                                <div class="value" id="predvidjanjeRezVrstaBeneficije">-</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Datum poslednjeg rada</div>
                                <div class="value" id="predvidjanjeRezDatumPoslednjegRada">-</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Beneficija (nakon obraƒçuna)</div>
                                <div class="value" id="predvidjanjeRezBeneficija">-</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Cele godine beneficije</div>
                                <div class="value" id="predvidjanjeRezCeleGodineBeneficije">-</div>
                            </div>
                            <div class="detail-item card-hover">
                                <div class="label">Donja granica</div>
                                <div class="value" id="predvidjanjeRezDonjaGranica">-</div>
                            </div>
                        </div>
                        
                        <!-- DETALJI ISPUNJENOG USLOVA -->
                        <div id="predvidjanjeUslovDetaljiContainer" class="uslov-detalji" style="display: none;">
                            <h4>üìã Detalji ispunjenog uslova:</h4>
                            <div id="predvidjanjeUslovDetaljiTekst"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DATA TAB -->
            <div class="tab-content" id="data">
                <h2>Pregled podataka po godinama</h2>
                
                <div class="action-buttons" style="margin-bottom: 20px;">
                    <button class="btn" id="dodajRedZarade">‚ûï Dodaj red za zaradu</button>
                    <button class="btn" id="dodajRedStaz">‚ûï Dodaj red za sta≈æ</button>
                    <button class="btn btn-success" id="sacuvajIzmene">üíæ Saƒçuvaj sve izmene</button>
                </div>
                
                <div class="flex-grid">
                    <div>
                        <h3>üìä Zarade i liƒçni koeficijenti</h3>
                        <div class="manual-edit-area card-hover">
                            <div class="edit-row header">
                                <div>Godina</div>
                                <div>Liƒçna zarada</div>
                                <div>Proseƒçna plata</div>
                                <div>Koeficijent</div>
                                <div>Sati rada</div>
                                <div>Sati bolovanja</div>
                                <div>Akcije</div>
                            </div>
                            <div id="zaradeEditContainer"></div>
                        </div>
                        <div id="emptyZarade" class="empty-state" style="display: none;">
                            <div>üì≠</div>
                            <p>Nema podataka o zaradama</p>
                        </div>
                    </div>
                    
                    <div>
                        <h3>üìÖ Sta≈æ po godinama</h3>
                        <div class="manual-edit-area card-hover">
                            <div class="edit-row header">
                                <div>Godina</div>
                                <div>Efektivni meseci</div>
                                <div>Efektivni dani</div>
                                <div>Benefic. meseci</div>
                                <div>Benefic. dani</div>
                                <div>Tip beneficiranja</div>
                                <div>Akcije</div>
                            </div>
                            <div id="stazEditContainer"></div>
                        </div>
                        <div id="emptyStaz" class="empty-state" style="display: none;">
                            <div>üì≠</div>
                            <p>Nema podataka o sta≈æu</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CONFIG TAB -->
            <div class="tab-content" id="config">
                <h2>‚öôÔ∏è Pode≈°avanja i korekcije</h2>
                
                <h3>üìà Proseƒçne plate po godinama (RSD)</h3>
                
                <div class="form-group">
                    <label>Dodaj/izmeni proseƒçnu platu:</label>
                    <div style="display: grid; grid-template-columns: 1fr 2fr auto; gap: 10px; align-items: end;">
                        <div>
                            <input type="number" id="novaGodina" placeholder="Godina" min="1990" max="2050">
                        </div>
                        <div>
                            <input type="number" id="novaPlata" placeholder="Proseƒçna godi≈°nja plata (RSD)">
                        </div>
                        <div>
                            <button class="btn btn-block" id="dodajPlatu">üíæ Saƒçuvaj</button>
                        </div>
                    </div>
                </div>
                
                <h3>üìã Trenutne proseƒçne plate</h3>
                <div class="table-container">
                    <table class="data-table" id="tabelaPlate">
                        <thead>
                            <tr>
                                <th data-sort="year">Godina</th>
                                <th data-sort="annual">Proseƒçna godi≈°nja plata</th>
                                <th data-sort="monthly">Proseƒçna meseƒçna plata</th>
                                <th>Akcije</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaPlateBody"></tbody>
                    </table>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-warning" id="resetujPlate">üîÑ Resetuj na podrazumevane vrednosti</button>
                    <button class="btn" id="exportPodataka">üì• Export podataka</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ====================
        // OSNOVNI PODACI
        // ====================
        
        // Proseƒçne GODI≈†NJE bruto zarade u Srbiji (RSD)
        let prosecnePlate = {
            "1995": 4116, "1996": 7896, "1997": 9576, "1998": 12624, "1999": 15132,
            "2000": 28668, "2001": 70080, "2002": 110496, "2003": 199344, "2004": 246660,
            "2005": 306168, "2006": 380940, "2007": 464928, "2008": 548088, "2009": 529764,
            "2010": 569400, "2011": 632796, "2012": 689160, "2013": 728496, "2014": 737112,
            "2015": 733740, "2016": 761688, "2017": 791712, "2018": 823548, "2019": 909768,
            "2020": 995808, "2021": 1089408, "2022": 1239792, "2023": 1423188, "2024": 1624836
        };
        
        // Tipovi beneficiranja
        const tipoviBeneficiranja = [
            { id: 'standard', naziv: 'Standardno', koeficijent: 0.3333 },
            { id: 'teski', naziv: 'Te≈°ki uslovi rada', koeficijent: 0.5 },
            { id: 'penal', naziv: 'Rad u penalima', koeficijent: 0.6667 },
            { id: 'vojska', naziv: 'Vojska/Policija', koeficijent: 1.0 }
        ];
        
        // Globalni podaci
        let rawExcelData = [];
        let aktivniKorisnikId = null;
        let korisnici = {};
        
        // ====================
        // NOVI UI KOMPONENTI
        // ====================
        
        class NotificationSystem {
            static show(message, type = 'info', duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <div class="notification-content">
                        <span class="notification-icon">${this.getIcon(type)}</span>
                        <span class="notification-text">${message}</span>
                        <button class="notification-close">&times;</button>
                    </div>
                `;
                
                document.getElementById('notificationContainer').appendChild(notification);
                
                // Animacija prikaza
                setTimeout(() => notification.classList.add('show'), 10);
                
                // Close dugme
                notification.querySelector('.notification-close').addEventListener('click', () => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                });
                
                // Automatsko zatvaranje
                if (duration > 0) {
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.classList.remove('show');
                            setTimeout(() => notification.remove(), 300);
                        }
                    }, duration);
                }
            }
            
            static getIcon(type) {
                const icons = {
                    success: '‚úì',
                    error: '‚úó',
                    info: '‚ÑπÔ∏è',
                    warning: '‚ö†Ô∏è'
                };
                return icons[type] || '‚ÑπÔ∏è';
            }
        }
        
        // ====================
        // INICIJALIZACIJA
        // ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupEventListeners();
            setupNewUIComponents();
            refreshKorisniciList();
            setupPredvidjanje();
            updateTabIndicator();
            updateBreadcrumb();
        });
        
        function initApp() {
            // Proveri temu
            const savedTheme = localStorage.getItem('penzijaTheme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
            
            // Uƒçitaj saƒçuvane podatke
            const savedKorisnici = localStorage.getItem('penzijaKorisnici');
            if (savedKorisnici) {
                try {
                    korisnici = JSON.parse(savedKorisnici);
                } catch (e) {
                    console.log("Nema saƒçuvanih korisnika");
                }
            }
            
            // Uƒçitaj proseƒçne plate
            const savedPlates = localStorage.getItem('prosecnePlateKalkulator');
            if (savedPlates) {
                try {
                    prosecnePlate = JSON.parse(savedPlates);
                } catch (e) {
                    console.log("Koristim podrazumevane plate");
                }
            }
            
            // Uƒçitaj tipove beneficiranja
            const savedTipovi = localStorage.getItem('tipoviBeneficiranja');
            if (savedTipovi) {
                try {
                    const loadedTipovi = JSON.parse(savedTipovi);
                    if (loadedTipovi && loadedTipovi.length > 0) {
                        tipoviBeneficiranja.length = 0;
                        loadedTipovi.forEach(tip => tipoviBeneficiranja.push(tip));
                    }
                } catch (e) {
                    console.log("Koristim podrazumevane tipove beneficiranja");
                }
            }
            
            // Postavi prvi korisnika kao aktivnog ako postoji
            if (Object.keys(korisnici).length > 0) {
                const prviKorisnikId = Object.keys(korisnici)[0];
                setAktivniKorisnik(prviKorisnikId);
            }
            
            refreshPlateTable();
        }
        
        function setupNewUIComponents() {
            // Dark/Light tema toggle - ISPRAVLJENO
            document.getElementById('themeToggle').addEventListener('click', function() {
                const isDark = document.body.getAttribute('data-theme') === 'dark';
                if (isDark) {
                    document.body.removeAttribute('data-theme');
                    this.textContent = 'üåô';
                    localStorage.setItem('penzijaTheme', 'light');
                } else {
                    document.body.setAttribute('data-theme', 'dark');
                    this.textContent = '‚òÄÔ∏è';
                    localStorage.setItem('penzijaTheme', 'dark');
                }
                
                // Osve≈æi prikaz da bi se primenili stilovi
                if (aktivniKorisnikId) {
                    updateDisplay();
                }
            });
            
            // Mobile tabs toggle
            document.getElementById('mobileTabsToggle').addEventListener('click', function() {
                const tabs = document.getElementById('tabsContainer');
                const icon = document.getElementById('mobileToggleIcon');
                
                if (tabs.classList.contains('show')) {
                    tabs.classList.remove('show');
                    icon.textContent = '‚ñº';
                } else {
                    tabs.classList.add('show');
                    icon.textContent = '‚ñ≤';
                }
            });
            
            // Breadcrumb navigacija
            document.querySelectorAll('.breadcrumb-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });
            
            // Dodaj sortiranje tabela
            setTimeout(() => {
                setupTableSorting('tabelaPlate');
                setupTableSorting('tabelaBolovanje');
            }, 100);
            
            // DROPDOWN za PDF
            setupPDFDropdown();
        }
        
        function setupPDFDropdown() {
            const dropdownToggle = document.querySelector('#pdfDropdown .dropdown-toggle');
            const dropdownContent = document.getElementById('pdfDropdownContent');
            
            // Toggle dropdown na klik
            dropdownToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                dropdownContent.classList.toggle('show');
            });
            
            // Zatvori dropdown kada se klikne van njega
            document.addEventListener('click', function(e) {
                if (!dropdownToggle.contains(e.target) && !dropdownContent.contains(e.target)) {
                    dropdownContent.classList.remove('show');
                }
            });
            
            // Zatvori dropdown kada se izabere opcija
            document.querySelectorAll('#pdfDropdownContent .dropdown-item').forEach(item => {
                item.addEventListener('click', function() {
                    dropdownContent.classList.remove('show');
                });
            });
            
            // Onemoguƒái klik na dropdown kada nema aktivnog korisnika
            dropdownToggle.addEventListener('click', function(e) {
                if (!aktivniKorisnikId) {
                    e.stopPropagation();
                    NotificationSystem.show('Izaberite korisnika prvo', 'error');
                    dropdownContent.classList.remove('show');
                }
            });
        }
        
        function setupTableSorting(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('th[data-sort]');
            headers.forEach(header => {
                header.style.cursor = 'pointer';
                header.addEventListener('click', () => {
                    const column = header.getAttribute('data-sort');
                    const isAsc = header.classList.contains('sort-asc');
                    
                    // Resetuj sve headere
                    headers.forEach(h => {
                        h.classList.remove('sort-asc', 'sort-desc');
                    });
                    
                    // Postavi novi sort order
                    if (isAsc) {
                        header.classList.add('sort-desc');
                        sortTable(tableId, column, 'desc');
                    } else {
                        header.classList.add('sort-asc');
                        sortTable(tableId, column, 'asc');
                    }
                });
            });
        }
        
        function sortTable(tableId, column, direction = 'asc') {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Sortiraj redove
            rows.sort((a, b) => {
                const aVal = getCellValue(a, column);
                const bVal = getCellValue(b, column);
                
                if (direction === 'asc') {
                    return compareValues(aVal, bVal);
                } else {
                    return compareValues(bVal, aVal);
                }
            });
            
            // Ponovo dodaj redove
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function getCellValue(row, column) {
            const index = Array.from(row.parentNode.querySelectorAll('th')).findIndex(th => th.getAttribute('data-sort') === column);
            const cell = row.children[index];
            
            if (!cell) return '';
            
            let value = cell.textContent || cell.innerText || '';
            
            // Za numeriƒçke vrednosti
            if (value.includes('RSD') || value.includes('din')) {
                value = value.replace(/[^\d,.-]/g, '').replace(',', '');
                return parseFloat(value) || 0;
            }
            
            // Za godine
            if (/^\d{4}$/.test(value.trim())) {
                return parseInt(value);
            }
            
            return value;
        }
        
        function compareValues(a, b) {
            if (typeof a === 'number' && typeof b === 'number') {
                return a - b;
            }
            return String(a).localeCompare(String(b));
        }
        
        function setupEventListeners() {
            // Tabovi
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Korisnici
            document.getElementById('dodajKorisnika').addEventListener('click', dodajKorisnika);
            
            // Excel upload
            document.getElementById('excelFile').addEventListener('change', handleExcelUpload);
            document.getElementById('obradiExcel').addEventListener('click', processAndCalculate);
            
            // Pode≈°avanja
            document.getElementById('godinaPenzionisanja').addEventListener('change', function() {
                if (aktivniKorisnikId) {
                    korisnici[aktivniKorisnikId].godinaPenzionisanja = parseInt(this.value) || 2024;
                    saveKorisnici();
                    updateDisplay();
                }
            });
            
            document.getElementById('opstiBodValue').addEventListener('change', function() {
                if (aktivniKorisnikId) {
                    korisnici[aktivniKorisnikId].opstiBod = parseFloat(this.value) || 1492.58;
                    saveKorisnici();
                    updateDisplay();
                }
            });
            
            // Upravljanje platama
            document.getElementById('dodajPlatu').addEventListener('click', dodajPlatu);
            document.getElementById('resetujPlate').addEventListener('click', resetujPlate);
            document.getElementById('exportPodataka').addEventListener('click', exportPodatakaPoboljsano);
            
            // Ruƒçna izmena podataka
            document.getElementById('dodajRedZarade').addEventListener('click', dodajRedZarade);
            document.getElementById('dodajRedStaz').addEventListener('click', dodajRedStaz);
            document.getElementById('sacuvajIzmene').addEventListener('click', sacuvajIzmenePodataka);
            
            // Shortcut kombinacije
            document.addEventListener('keydown', (e) => {
                // Ctrl + S za ƒçuvanje
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    if (aktivniKorisnikId) {
                        sacuvajIzmenePodataka();
                    }
                }
                
                // Ctrl + 1-7 za prebacivanje tabova
                if (e.ctrlKey && e.key >= '1' && e.key <= '7') {
                    const tabs = ['users', 'excel', 'calculation', 'statistika', 'predvidjanje', 'data', 'config'];
                    const tabIndex = parseInt(e.key) - 1;
                    if (tabs[tabIndex]) {
                        switchTab(tabs[tabIndex]);
                    }
                }
                
                // Escape za zatvaranje mobile menua
                if (e.key === 'Escape') {
                    document.getElementById('tabsContainer').classList.remove('show');
                    document.getElementById('mobileToggleIcon').textContent = '‚ñº';
                }
            });
        }
        
        function setupPredvidjanje() {
            // Postavi dana≈°nji datum za datum poslednjeg rada
            const today = new Date();
            const danasStr = formatDate(today);
            document.getElementById('predvidjanjeDatumPoslednjegRada').value = danasStr;
            
            // Auto-format datuma
            const dateInputs = ['predvidjanjeDatumRodjenja', 'predvidjanjeDatumPoslednjegRada'];
            dateInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('blur', () => formatDateInput(input));
            });
            
            // Validacija za mesece i dane
            const meseciInputs = ['predvidjanjeEfektivniMeseci', 'predvidjanjeBeneficiraniMeseci'];
            meseciInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('change', function() {
                    if (this.value < 0) this.value = 0;
                    if (this.value > 11) this.value = 11;
                });
            });
            
            const daniInputs = ['predvidjanjeEfektivniDani', 'predvidjanjeBeneficiraniDani'];
            daniInputs.forEach(id => {
                const input = document.getElementById(id);
                input.addEventListener('change', function() {
                    if (this.value < 0) this.value = 0;
                    if (this.value > 30) this.value = 30;
                });
            });
            
            // Dugmad za predviƒëanje
            document.getElementById('preuzmiStazBtn').addEventListener('click', preuzmiStazIzStatistike);
            document.getElementById('predvidjanjeIzracunajBtn').addEventListener('click', izracunajPredvidjanje);
            
            // Postavi primer
            document.getElementById('predvidjanjeDatumRodjenja').value = '09.04.1971';
            document.getElementById('predvidjanjeEfektivniGodine').value = '29';
            document.getElementById('predvidjanjeEfektivniMeseci').value = '7';
            document.getElementById('predvidjanjeEfektivniDani').value = '0';
            document.getElementById('predvidjanjeBeneficiraniGodine').value = '28';
            document.getElementById('predvidjanjeBeneficiraniMeseci').value = '2';
            document.getElementById('predvidjanjeBeneficiraniDani').value = '24';
            document.getElementById('predvidjanjeVrstaBeneficije').value = '12/16';
            document.getElementById('predvidjanjeDatumPoslednjegRada').value = '31.12.2024';
        }
        
        function switchTab(tabId) {
            // Zatvori mobile menu ako je otvoren
            document.getElementById('tabsContainer').classList.remove('show');
            document.getElementById('mobileToggleIcon').textContent = '‚ñº';
            
            // A≈æuriraj tabove
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // A≈æuriraj tab indicator
            updateTabIndicator();
            
            // A≈æuriraj breadcrumb
            updateBreadcrumb();
            
            // Specificne akcije za svaki tab
            if (tabId === 'config') {
                refreshPlateTable();
            } else if (tabId === 'statistika') {
                prikaziStatistikuStaza();
            } else if (tabId === 'calculation') {
                prikaziTabeluBolovanja();
                prikaziUslov23();
            } else if (tabId === 'predvidjanje') {
                // Mo≈æda automatski preuzmi sta≈æ kada se otvori tab
            }
            
            // Scroll na vrh
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updateTabIndicator() {
            const activeTab = document.querySelector('.tab.active');
            const indicator = document.getElementById('tabIndicator');
            
            if (activeTab && indicator) {
                const tabRect = activeTab.getBoundingClientRect();
                const tabsRect = activeTab.parentNode.getBoundingClientRect();
                
                indicator.style.left = (tabRect.left - tabsRect.left) + 'px';
                indicator.style.width = tabRect.width + 'px';
            }
        }
        
        function updateBreadcrumb() {
            const activeTab = document.querySelector('.tab.active');
            const tabId = activeTab ? activeTab.getAttribute('data-tab') : 'users';
            
            const breadcrumbMap = {
                'users': 'üë• Korisnici',
                'excel': 'üìä Excel Import',
                'calculation': 'üßÆ Rezultati Obraƒçuna',
                'statistika': 'üìà Statistika Sta≈æa',
                'predvidjanje': 'üìÖ Predviƒëanje Datuma',
                'data': 'üìã Pregled Podataka',
                'config': '‚öôÔ∏è Pode≈°avanja'
            };
            
            let breadcrumbHTML = `<span class="breadcrumb-item" data-tab="users">üë• Korisnici</span>`;
            
            if (tabId !== 'users') {
                breadcrumbHTML += `
                    <span class="breadcrumb-separator">‚Ä∫</span>
                    <span class="breadcrumb-item" data-tab="${tabId}">${breadcrumbMap[tabId]}</span>
                `;
            }
            
            document.getElementById('breadcrumb').innerHTML = breadcrumbHTML;
            
            // Ponovo dodaj event listenere
            document.querySelectorAll('.breadcrumb-item').forEach(item => {
                item.addEventListener('click', function() {
                    const tab = this.getAttribute('data-tab');
                    switchTab(tab);
                });
            });
        }
        
        // ====================
        // ORIGINALNE FUNKCIJE (KOMPLETNO KOPIRANE)
        // ====================
        
        function refreshKorisniciList() {
            const container = document.getElementById('listaKorisnika');
            container.innerHTML = '';
            
            if (Object.keys(korisnici).length === 0) {
                container.innerHTML = '<div class="empty-state"><div>üë§</div><p>Nema saƒçuvanih korisnika</p></div>';
                return;
            }
            
            Object.keys(korisnici).forEach(korisnikId => {
                const korisnik = korisnici[korisnikId];
                const div = document.createElement('div');
                div.className = `user-item ${korisnikId === aktivniKorisnikId ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="user-name">${korisnik.ime}</div>
                    <div class="user-info">
                        Godina penzije: ${korisnik.godinaPenzionisanja}<br>
                        Penzija: ${korisnik.penzijaMesecno ? formatCurrency(korisnik.penzijaMesecno) : 'Nije izraƒçunato'}
                    </div>
                    <div class="action-buttons" style="margin-top: 10px; justify-content: flex-end;">
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="izmeniKorisnika('${korisnikId}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" onclick="obrisiKorisnika('${korisnikId}')">üóëÔ∏è</button>
                    </div>
                `;
                
                div.addEventListener('click', function(e) {
                    if (!e.target.closest('button')) {
                        setAktivniKorisnik(korisnikId);
                    }
                });
                
                container.appendChild(div);
            });
        }
        
        function dodajKorisnika() {
            const imeInput = document.getElementById('noviKorisnikIme');
            const ime = imeInput.value.trim();
            
            if (!ime) {
                NotificationSystem.show('Unesite ime korisnika', 'error');
                return;
            }
            
            const korisnikId = 'k' + Date.now();
            korisnici[korisnikId] = {
                id: korisnikId,
                ime: ime,
                godinaPenzionisanja: 2024,
                opstiBod: 1492.58,
                zarade: [],
                staz: [],
                penzijaMesecno: 0,
                penzijaGodisnja: 0,
                datumKreiranja: new Date().toISOString(),
                datumAzuriranja: new Date().toISOString()
            };
            
            saveKorisnici();
            refreshKorisniciList();
            setAktivniKorisnik(korisnikId);
            
            imeInput.value = '';
            NotificationSystem.show(`Korisnik "${ime}" uspe≈°no dodat`, 'success');
        }
        
        function izmeniKorisnika(korisnikId) {
            const korisnik = korisnici[korisnikId];
            const novoIme = prompt('Unesite novo ime korisnika:', korisnik.ime);
            
            if (novoIme && novoIme.trim() !== korisnik.ime) {
                korisnik.ime = novoIme.trim();
                korisnik.datumAzuriranja = new Date().toISOString();
                saveKorisnici();
                refreshKorisniciList();
                NotificationSystem.show('Ime korisnika uspe≈°no izmenjeno', 'success');
            }
        }
        
        function obrisiKorisnika(korisnikId) {
            if (!confirm(`Da li ste sigurni da ≈æelite da obri≈°ete korisnika "${korisnici[korisnikId].ime}"?`)) {
                return;
            }
            
            delete korisnici[korisnikId];
            
            // Ako je bio aktivni korisnik, postavi prvi korisnika kao aktivnog
            if (aktivniKorisnikId === korisnikId) {
                const preostaliKorisnici = Object.keys(korisnici);
                if (preostaliKorisnici.length > 0) {
                    setAktivniKorisnik(preostaliKorisnici[0]);
                } else {
                    aktivniKorisnikId = null;
                    document.getElementById('korisnikDetalji').innerHTML = `
                        <div class="empty-state">
                            <div>üë§</div>
                            <p>Nema aktivnog korisnika</p>
                        </div>
                    `;
                }
            }
            
            saveKorisnici();
            refreshKorisniciList();
            NotificationSystem.show('Korisnik uspe≈°no obrisan', 'success');
        }
        
        function setAktivniKorisnik(korisnikId) {
            aktivniKorisnikId = korisnikId;
            const korisnik = korisnici[korisnikId];
            
            refreshKorisniciList();
            
            // A≈æuriraj naslove tabova
            document.getElementById('excelNaslov').textContent = 
                `Uvoz podataka iz Excel fajla za ${korisnik.ime}`;
            document.getElementById('statistikaNaslov').textContent = 
                `Statistika sta≈æa za ${korisnik.ime}`;
            
            // A≈æuriraj forme
            document.getElementById('godinaPenzionisanja').value = korisnik.godinaPenzionisanja;
            document.getElementById('opstiBodValue').value = korisnik.opstiBod;
            
            // Prika≈æi detalje korisnika - UKLONJEN ID KORISNIKA
            document.getElementById('korisnikDetalji').innerHTML = `
                <h3>Detalji korisnika: ${korisnik.ime}</h3>
                <div class="details-grid" style="margin-top: 20px;">
                    <div class="detail-item">
                        <div class="label">Datum kreiranja</div>
                        <div class="value">${new Date(korisnik.datumKreiranja).toLocaleDateString('sr-RS')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Datum a≈æuriranja</div>
                        <div class="value">${new Date(korisnik.datumAzuriranja).toLocaleDateString('sr-RS')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Broj godina podataka</div>
                        <div class="value">${korisnik.zarade.length}</div>
                    </div>
                    <div class="detail-item">
                        <div class="label">Godina penzionisanja</div>
                        <div class="value">${korisnik.godinaPenzionisanja}</div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h3>Brza akcija:</h3>
                    <div class="action-buttons">
                        <button class="btn" onclick="switchTab('excel')">üìä Uƒçitaj Excel podatke</button>
                        <button class="btn" onclick="switchTab('calculation')">üßÆ Prika≈æi obraƒçun</button>
                        <button class="btn" onclick="switchTab('statistika')">üìà Statistika sta≈æa</button>
                        <button class="btn" onclick="switchTab('predvidjanje')">üìÖ Predviƒëanje datuma</button>
                        <button class="btn" onclick="exportPodatakaKorisnikaPoboljsano('${korisnikId}')">üì• Export podataka</button>
                    </div>
                </div>
            `;
            
            // A≈æuriraj prikaz
            updateDisplay();
            prikaziTabeluBolovanja();
            prikaziUslov23();
        }
        
        function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            NotificationSystem.show('Uƒçitavam Excel fajl...', 'info');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    rawExcelData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    NotificationSystem.show(`‚úì Excel fajl uspe≈°no uƒçit√°n (${rawExcelData.length} redova)`, 'success');
                    document.getElementById('obradiExcel').disabled = false;
                    
                } catch (error) {
                    NotificationSystem.show(`‚úó Gre≈°ka pri uƒçitavanju: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                NotificationSystem.show('‚úó Gre≈°ka pri ƒçitanju fajla', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function processAndCalculate() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            NotificationSystem.show('Obradjujem podatke i raƒçunam penziju...', 'info');
            
            try {
                // 1. Obradi Excel podatke
                obradiExcelPodatkeIspravno();
                
                // 2. Izraƒçunaj penziju
                const rezultat = izracunajPenziju();
                
                // 3. Saƒçuvaj rezultate u korisnika
                const korisnik = korisnici[aktivniKorisnikId];
                korisnik.penzijaMesecno = rezultat.penzijaMesecno;
                korisnik.penzijaGodisnja = rezultat.penzija;
                
                // 4. Prika≈æi rezultate
                prikaziRezultate(rezultat);
                
                // 5. Prika≈æi uslov 2/3
                prikaziUslov23();
                
                // 6. Saƒçuvaj podatke
                saveKorisnici();
                
                NotificationSystem.show(`‚úì Obraƒçun zavr≈°en! Penzija: ${formatCurrency(rezultat.penzijaMesecno)} meseƒçno`, 'success');
                switchTab('calculation');
                
            } catch (error) {
                NotificationSystem.show(`‚úó Gre≈°ka: ${error.message}`, 'error');
            }
        }
        
        function obradiExcelPodatkeIspravno() {
            if (!aktivniKorisnikId) return;
            
            const korisnik = korisnici[aktivniKorisnikId];
            
            // Resetuj podatke
            korisnik.zarade = [];
            korisnik.staz = [];
            
            const rezultatiPoGodini = {};
            let poslednjaGodina = null;
            
            // Pronaƒëi poƒçetak podataka
            let startIndex = -1;
            for (let i = 0; i < rawExcelData.length; i++) {
                if (rawExcelData[i] && rawExcelData[i][0] === 'Godina') {
                    startIndex = i + 1;
                    break;
                }
            }
            
            if (startIndex === -1) throw new Error('Nije pronaƒëen poƒçetak tabele');
            
            // Faza 1: Prikupi sve podatke
            for (let i = startIndex; i < rawExcelData.length; i++) {
                const red = rawExcelData[i];
                if (!red || red.length < 11) continue;
                
                const godinaCell = red[0];
                const obrazac = red[1];
                
                if (!obrazac || (obrazac !== 'M4' && obrazac !== 'M8')) continue;
                
                // Odredi godinu
                let godina = null;
                if (jeValidnaGodina(godinaCell)) {
                    godina = konvertujGodinu(godinaCell);
                    poslednjaGodina = godina;
                } else if (poslednjaGodina) {
                    godina = poslednjaGodina;
                } else {
                    continue;
                }
                
                // Inicijalizuj godinu ako ne postoji
                if (!rezultatiPoGodini[godina]) {
                    rezultatiPoGodini[godina] = {
                        m4Zarada: { h: 0, k: 0 },
                        m8Zarada: { h: 0, k: 0 },
                        satiRada: 0,
                        satiBolovanje: 0,
                        staz: { meseci: 0, dani: 0, beneficiraniMeseci: 0, beneficiraniDani: 0, tipBeneficiranja: 'standard' },
                        m8Staz: null
                    };
                }
                
                const podaci = rezultatiPoGodini[godina];
                const jeDonjiRed = !jeValidnaGodina(godinaCell);
                
                // Parsiraj vrednosti - DODATE KOLONE G i J
                const satiRada = parseInt(red[6]) || 0;      // Kolona G - sati rada
                const hVrednost = parsirajBroj(red[7]);      // Kolona H - zarada
                const satiBolovanje = parseInt(red[9]) || 0; // Kolona J - sati bolovanja
                const kVrednost = parsirajBroj(red[10]);     // Kolona K - dodatna zarada
                const meseciStaz = parseFloat(red[4]) || 0;
                const daniStaz = parseFloat(red[5]) || 0;
                const beneficiraniMeseci = parseFloat(red[12]) || 0;
                const beneficiraniDani = parseFloat(red[13]) || 0;
                
                if (obrazac === 'M4') {
                    if (!jeDonjiRed) {
                        podaci.m4Zarada.h += hVrednost;
                        podaci.m4Zarada.k += kVrednost;
                        podaci.satiRada += satiRada;
                        podaci.satiBolovanje += satiBolovanje;
                        podaci.staz.meseci += meseciStaz;
                        podaci.staz.dani += daniStaz;
                        podaci.staz.beneficiraniMeseci += beneficiraniMeseci;
                        podaci.staz.beneficiraniDani += beneficiraniDani;
                    }
                } else if (obrazac === 'M8') {
                    if (!jeDonjiRed) {
                        if (hVrednost > 0 || kVrednost > 0) {
                            podaci.m8Zarada.h = hVrednost;
                            podaci.m8Zarada.k = kVrednost;
                        }
                        if (satiRada > 0 || satiBolovanje > 0) {
                            podaci.satiRada = satiRada;
                            podaci.satiBolovanje = satiBolovanje;
                        }
                        if (meseciStaz > 0 || daniStaz > 0) {
                            podaci.m8Staz = {
                                meseci: meseciStaz,
                                dani: daniStaz,
                                beneficiraniMeseci: beneficiraniMeseci,
                                beneficiraniDani: beneficiraniDani,
                                tipBeneficiranja: 'standard'
                            };
                        }
                    }
                }
            }
            
            // Faza 2: Kombinuj podatke
            Object.keys(rezultatiPoGodini).forEach(godinaStr => {
                const godina = parseInt(godinaStr);
                const podaci = rezultatiPoGodini[godina];
                
                // ZARADA: M8 overwrite M4
                let ukupnaZarada = podaci.m4Zarada.h + podaci.m4Zarada.k;
                if (podaci.m8Zarada.h > 0 || podaci.m8Zarada.k > 0) {
                    ukupnaZarada = podaci.m8Zarada.h + podaci.m8Zarada.k;
                }
                
                // Dodaj zaradu sa satima rada i bolovanja
                if (ukupnaZarada > 0 || podaci.satiRada > 0 || podaci.satiBolovanje > 0) {
                    const prosecnaPlata = prosecnePlate[godina] || 0;
                    if (prosecnaPlata > 0) {
                        korisnik.zarade.push({
                            godina: godina,
                            licnaZarada: ukupnaZarada,
                            prosecnaPlata: prosecnaPlata,
                            satiRada: podaci.satiRada,
                            satiBolovanje: podaci.satiBolovanje
                        });
                    }
                }
                
                // STA≈Ω: M8 overwrite M4
                let efektivniMeseci = podaci.staz.meseci;
                let efektivniDani = podaci.staz.dani;
                let beneficiraniMeseci = podaci.staz.beneficiraniMeseci;
                let beneficiraniDani = podaci.staz.beneficiraniDani;
                let tipBeneficiranja = podaci.staz.tipBeneficiranja;
                
                if (podaci.m8Staz) {
                    efektivniMeseci = podaci.m8Staz.meseci;
                    efektivniDani = podaci.m8Staz.dani;
                    beneficiraniMeseci = podaci.m8Staz.beneficiraniMeseci;
                    beneficiraniDani = podaci.m8Staz.beneficiraniDani;
                    tipBeneficiranja = podaci.m8Staz.tipBeneficiranja;
                }
                
                // Dodaj sta≈æ
                if (efektivniMeseci > 0 || efektivniDani > 0 || beneficiraniMeseci > 0 || beneficiraniDani > 0) {
                    korisnik.staz.push({
                        godina: godina,
                        efektivniMeseci: efektivniMeseci,
                        efektivniDani: efektivniDani,
                        beneficiraniMeseci: beneficiraniMeseci,
                        beneficiraniDani: beneficiraniDani,
                        tipBeneficiranja: tipBeneficiranja
                    });
                }
            });
            
            // Sortiraj podatke po godini
            korisnik.zarade.sort((a, b) => a.godina - b.godina);
            korisnik.staz.sort((a, b) => a.godina - b.godina);
        }
        
        function dodajRedZarade() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            const container = document.getElementById('zaradeEditContainer');
            const div = document.createElement('div');
            div.className = 'edit-row';
            div.innerHTML = `
                <input type="number" class="edit-godina" placeholder="Godina" min="1990" max="2050">
                <input type="number" class="edit-licna-zarada" placeholder="Liƒçna zarada" min="0" step="0.01">
                <input type="number" class="edit-prosecna-plata" placeholder="Proseƒçna plata" min="0" step="0.01">
                <div class="koeficijent-placeholder">-</div>
                <input type="number" class="edit-sati-rada" placeholder="Sati rada" min="0" step="1">
                <input type="number" class="edit-sati-bolovanje" placeholder="Sati bolovanja" min="0" step="1">
                <div class="actions-cell">
                    <button class="btn btn-danger" onclick="obrisiRedZarade(this)">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(div);
        }
        
        function obrisiRedZarade(button) {
            const row = button.closest('.edit-row');
            row.remove();
        }
        
        function dodajRedStaz() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            const container = document.getElementById('stazEditContainer');
            const div = document.createElement('div');
            div.className = 'edit-row';
            
            // Kreiraj opcije za tip beneficiranja
            let tipOptions = '<option value="standard">Standardno (0.3333)</option>';
            tipOptions += '<option value="teski">Te≈°ki uslovi (0.5)</option>';
            tipOptions += '<option value="penal">Rad u penalima (0.6667)</option>';
            tipOptions += '<option value="vojska">Vojska/Policija (1.0)</option>';
            
            div.innerHTML = `
                <input type="number" class="edit-godina-staz" placeholder="Godina" min="1990" max="2050">
                <input type="number" class="edit-meseci" placeholder="Meseci" min="0" max="12" step="1">
                <input type="number" class="edit-dani" placeholder="Dani" min="0" max="30" step="1">
                <input type="number" class="edit-beneficirani-meseci" placeholder="Benef. meseci" min="0" max="12" step="1">
                <input type="number" class="edit-beneficirani-dani" placeholder="Benef. dani" min="0" max="30" step="1">
                <select class="edit-tip-beneficiranja">
                    ${tipOptions}
                </select>
                <div class="actions-cell">
                    <button class="btn btn-danger" onclick="obrisiRedStaz(this)">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(div);
        }
        
        function obrisiRedStaz(button) {
            const row = button.closest('.edit-row');
            row.remove();
        }
        
        function sacuvajIzmenePodataka() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            
            // Prikupljanje zarada
            const zarade = [];
            const zaradeRows = document.querySelectorAll('#zaradeEditContainer .edit-row');
            
            zaradeRows.forEach(row => {
                const godina = parseInt(row.querySelector('.edit-godina').value);
                const licnaZarada = parseFloat(row.querySelector('.edit-licna-zarada').value) || 0;
                const prosecnaPlata = parseFloat(row.querySelector('.edit-prosecnaPlata').value) || 0;
                const satiRada = parseFloat(row.querySelector('.edit-sati-rada').value) || 0;
                const satiBolovanje = parseFloat(row.querySelector('.edit-sati-bolovanje').value) || 0;
                
                if (godina && (licnaZarada > 0 || satiRada > 0 || satiBolovanje > 0)) {
                    zarade.push({
                        godina: godina,
                        licnaZarada: licnaZarada,
                        prosecnaPlata: prosecnaPlata,
                        satiRada: satiRada,
                        satiBolovanje: satiBolovanje
                    });
                }
            });
            
            // Prikupljanje sta≈æa
            const staz = [];
            const stazRows = document.querySelectorAll('#stazEditContainer .edit-row');
            
            stazRows.forEach(row => {
                const godina = parseInt(row.querySelector('.edit-godina-staz').value);
                const meseci = parseFloat(row.querySelector('.edit-meseci').value) || 0;
                const dani = parseFloat(row.querySelector('.edit-dani').value) || 0;
                const beneficiraniMeseci = parseFloat(row.querySelector('.edit-beneficirani-meseci').value) || 0;
                const beneficiraniDani = parseFloat(row.querySelector('.edit-beneficirani-dani').value) || 0;
                const tipBeneficiranja = row.querySelector('.edit-tip-beneficiranja').value || 'standard';
                
                if (godina && (meseci > 0 || dani > 0 || beneficiraniMeseci > 0 || beneficiraniDani > 0)) {
                    staz.push({
                        godina: godina,
                        efektivniMeseci: meseci,
                        efektivniDani: dani,
                        beneficiraniMeseci: beneficiraniMeseci,
                        beneficiraniDani: beneficiraniDani,
                        tipBeneficiranja: tipBeneficiranja
                    });
                }
            });
            
            // Saƒçuvaj u korisnika
            korisnik.zarade = zarade;
            korisnik.staz = staz;
            korisnik.datumAzuriranja = new Date().toISOString();
            
            // Izraƒçunaj ponovo penziju
            const rezultat = izracunajPenziju();
            korisnik.penzijaMesecno = rezultat.penzijaMesecno;
            korisnik.penzijaGodisnja = rezultat.penzija;
            
            // Saƒçuvaj
            saveKorisnici();
            refreshKorisniciList();
            updateDisplay();
            prikaziUslov23();
            
            NotificationSystem.show('Izmene uspe≈°no saƒçuvane', 'success');
        }
        
        function izracunajPenziju() {
            if (!aktivniKorisnikId) {
                return {
                    penzija: 0,
                    penzijaMesecno: 0,
                    licniKoeficijent: 0,
                    koeficijentBolovanja: 0,
                    efektivniStazGodine: 0,
                    penzijskiStazGodine: 0,
                    opstiBod: 1492.58,
                    brojGodina: 0,
                    podaciBolovanje: []
                };
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            
            // 1. Izraƒçunaj koeficijent bolovanja
            const koeficijentBolovanja = izracunajKoeficijentBolovanja();
            
            // 2. Izraƒçunaj efektivni sta≈æ (za liƒçni koeficijent)
            const efektivniStazGodine = izracunajEfektivniStazGodine();
            
            // 3. Izraƒçunaj liƒçni koeficijent (sa koeficijentom bolovanja)
            const licniKoeficijent = izracunajLicniKoeficijent(koeficijentBolovanja, efektivniStazGodine);
            
            // 4. Izraƒçunaj penzijski sta≈æ (u godinama) - za finalnu penziju
            const penzijskiStazGodine = izracunajPenzijskiStaz();
            
            // 5. Uzmi op≈°ti bod
            const opstiBod = korisnik.opstiBod;
            
            // 6. PRIMENI FORMULU
            const penzijaMesecna = licniKoeficijent * penzijskiStazGodine * opstiBod;
            const penzijaGodisnja = penzijaMesecna * 12;
            
            return {
                penzija: Math.round(penzijaGodisnja),
                penzijaMesecno: Math.round(penzijaMesecna),
                licniKoeficijent: licniKoeficijent,
                koeficijentBolovanja: koeficijentBolovanja.koeficijent,
                efektivniStazGodine: efektivniStazGodine,
                penzijskiStazGodine: penzijskiStazGodine,
                opstiBod: opstiBod,
                brojGodina: korisnik.zarade.length,
                podaciBolovanje: koeficijentBolovanja.podaci
            };
        }
        
        function izracunajEfektivniStazGodine() {
            if (!aktivniKorisnikId) return 0;
            
            const korisnik = korisnici[aktivniKorisnikId];
            let ukupniMeseci = 0;
            
            korisnik.staz.forEach(staz => {
                const efektivniMeseci = staz.efektivniMeseci + (staz.efektivniDani / 30);
                ukupniMeseci += efektivniMeseci;
            });
            
            return ukupniMeseci / 12;
        }
        
        function izracunajKoeficijentBolovanja() {
            if (!aktivniKorisnikId) {
                return { koeficijent: 0, podaci: [] };
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            if (korisnik.zarade.length === 0) {
                return { koeficijent: 0, podaci: [] };
            }
            
            let zbirSatiRadaDo2002 = 0;
            let zbirSatiBolDo2002 = 0;
            let zbirLKDo2002 = 0;
            const podaciBolovanje = [];
            
            korisnik.zarade.forEach(red => {
                if (red.godina <= 2002) {
                    const satiRada = red.satiRada || 0;
                    const satiBol = red.satiBolovanje || 0;
                    
                    zbirSatiRadaDo2002 += satiRada;
                    zbirSatiBolDo2002 += satiBol;
                    
                    const repProsek = prosecnePlate[red.godina] || 0;
                    const zaradaUkupna = red.licnaZarada || 0;
                    let godisnjiLK = 0;
                    
                    if (repProsek > 0 && zaradaUkupna > 0) {
                        godisnjiLK = zaradaUkupna / repProsek;
                        godisnjiLK = Math.max(0.18, Math.min(godisnjiLK, 5.0));
                    }
                    
                    zbirLKDo2002 += godisnjiLK;
                    
                    podaciBolovanje.push({
                        godina: red.godina,
                        satiRada: satiRada,
                        satiBolovanje: satiBol,
                        godisnjiLK: godisnjiLK,
                        doprinos: satiRada > 0 ? (satiBol / satiRada) * godisnjiLK : 0
                    });
                }
            });
            
            let koeficijentBolovanja = 0;
            if (zbirSatiRadaDo2002 > 0) {
                koeficijentBolovanja = (zbirSatiBolDo2002 / zbirSatiRadaDo2002) * zbirLKDo2002;
            }
            
            return {
                koeficijent: koeficijentBolovanja,
                podaci: podaciBolovanje,
                zbirSatiRada: zbirSatiRadaDo2002,
                zbirSatiBol: zbirSatiBolDo2002,
                zbirLK: zbirLKDo2002
            };
        }
        
        function izracunajLicniKoeficijent(koeficijentBolovanja = null, efektivniStazGodine = null) {
            if (!aktivniKorisnikId) return 0;
            
            const korisnik = korisnici[aktivniKorisnikId];
            if (korisnik.zarade.length === 0) return 0;
            
            if (!efektivniStazGodine) {
                efektivniStazGodine = izracunajEfektivniStazGodine();
            }
            
            if (efektivniStazGodine === 0) return 0;
            
            let sumaGodisnjihKoeficijenata = 0;
            let brojGodina = 0;
            
            korisnik.zarade.forEach(zarada => {
                if (zarada.prosecnaPlata > 0 && zarada.licnaZarada > 0) {
                    let koeficijent = zarada.licnaZarada / zarada.prosecnaPlata;
                    koeficijent = Math.max(0.18, Math.min(koeficijent, 5.0));
                    
                    sumaGodisnjihKoeficijenata += koeficijent;
                    brojGodina++;
                }
            });
            
            if (brojGodina === 0) return 0;
            
            let ukupniZbir = sumaGodisnjihKoeficijenata;
            if (koeficijentBolovanja && koeficijentBolovanja.koeficijent > 0) {
                ukupniZbir += koeficijentBolovanja.koeficijent;
            }
            
            let licniKoeficijent = ukupniZbir / efektivniStazGodine;
            licniKoeficijent = Math.min(licniKoeficijent, 3.8);
            
            return licniKoeficijent;
        }
        
        function izracunajPenzijskiStaz() {
            if (!aktivniKorisnikId) return 0;
            
            const korisnik = korisnici[aktivniKorisnikId];
            let ukupniMeseci = 0;
            
            korisnik.staz.forEach(staz => {
                const efektivniMeseci = staz.efektivniMeseci + (staz.efektivniDani / 30);
                
                const tipInfo = tipoviBeneficiranja.find(t => t.id === staz.tipBeneficiranja);
                const koeficijent = tipInfo ? tipInfo.koeficijent : 0.3333;
                
                const beneficiraniMeseci = (staz.beneficiraniMeseci + (staz.beneficiraniDani / 30)) * koeficijent;
                ukupniMeseci += efektivniMeseci + beneficiraniMeseci;
            });
            
            return ukupniMeseci / 12;
        }
        
        function izracunajStatistikuStaza() {
            if (!aktivniKorisnikId) {
                return {
                    ukupno: { godine: 0, meseci: 0, dani: 0 },
                    efektivni: { godine: 0, meseci: 0, dani: 0 },
                    beneficiraniPre: { godine: 0, meseci: 0, dani: 0 },
                    beneficiraniPosle: { godine: 0, meseci: 0, dani: 0 },
                    poTipu: [],
                    poGodini: []
                };
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            
            let ukupnoDani = 0;
            let efektivniDani = 0;
            let beneficiraniPreDani = 0;
            let beneficiraniPosleDani = 0;
            
            const poTipuMap = {};
            const poGodini = [];
            
            tipoviBeneficiranja.forEach(tip => {
                poTipuMap[tip.id] = {
                    naziv: tip.naziv,
                    koeficijent: tip.koeficijent,
                    brojGodina: 0,
                    meseciPre: 0,
                    meseciPosle: 0,
                    doprinosGodine: 0
                };
            });
            
            korisnik.staz.forEach(staz => {
                const efektivniMeseci = staz.efektivniMeseci;
                const efektivniDaniStaz = staz.efektivniDani;
                const beneficiraniMeseci = staz.beneficiraniMeseci;
                const beneficiraniDaniStaz = staz.beneficiraniDani;
                
                const tipInfo = tipoviBeneficiranja.find(t => t.id === staz.tipBeneficiranja);
                const koeficijent = tipInfo ? tipInfo.koeficijent : 0.3333;
                const tipNaziv = tipInfo ? tipInfo.naziv : 'Standardno';
                
                const efektivniDaniUkupno = efektivniMeseci * 30 + efektivniDaniStaz;
                const beneficiraniDaniUkupno = beneficiraniMeseci * 30 + beneficiraniDaniStaz;
                const beneficiraniDaniPosle = beneficiraniDaniUkupno * koeficijent;
                
                const doprinos = (efektivniDaniUkupno / 30 + beneficiraniDaniPosle / 30) / 12;
                
                ukupnoDani += efektivniDaniUkupno + beneficiraniDaniPosle;
                efektivniDani += efektivniDaniUkupno;
                beneficiraniPreDani += beneficiraniDaniUkupno;
                beneficiraniPosleDani += beneficiraniDaniPosle;
                
                if (poTipuMap[staz.tipBeneficiranja]) {
                    poTipuMap[staz.tipBeneficiranja].brojGodina++;
                    poTipuMap[staz.tipBeneficiranja].meseciPre += beneficiraniDaniUkupno / 30;
                    poTipuMap[staz.tipBeneficiranja].meseciPosle += beneficiraniDaniPosle / 30;
                    poTipuMap[staz.tipBeneficiranja].doprinosGodine += beneficiraniDaniPosle / 360;
                }
                
                poGodini.push({
                    godina: staz.godina,
                    efektivniMeseci: efektivniMeseci,
                    efektivniDani: efektivniDaniStaz,
                    beneficiraniMeseci: beneficiraniMeseci,
                    beneficiraniDani: beneficiraniDaniStaz,
                    tipId: staz.tipBeneficiranja,
                    tipNaziv: tipNaziv,
                    koeficijent: koeficijent,
                    doprinos: doprinos
                });
            });
            
            const poTipu = Object.values(poTipuMap).filter(tip => tip.brojGodina > 0);
            poGodini.sort((a, b) => a.godina - b.godina);
            
            const formatirajVreme = (dani) => {
                const godine = Math.floor(dani / 360);
                const preostaloDani = dani % 360;
                const meseci = Math.floor(preostaloDani / 30);
                const daniOstatak = Math.round(preostaloDani % 30);
                
                return {
                    godine: godine,
                    meseci: meseci,
                    dani: daniOstatak
                };
            };
            
            return {
                ukupno: formatirajVreme(ukupnoDani),
                efektivni: formatirajVreme(efektivniDani),
                beneficiraniPre: formatirajVreme(beneficiraniPreDani),
                beneficiraniPosle: formatirajVreme(beneficiraniPosleDani),
                poTipu: poTipu,
                poGodini: poGodini
            };
        }
        
        function prikaziStatistikuStaza() {
            if (!aktivniKorisnikId) {
                document.getElementById('statistikaContainer').innerHTML = `
                    <div class="empty-state">
                        <div>üìä</div>
                        <p>Izaberite korisnika da biste videli statistiku sta≈æa</p>
                    </div>
                `;
                return;
            }
            
            const statistika = izracunajStatistikuStaza();
            
            let html = `
                <div class="result-box" style="background: linear-gradient(135deg, #27ae60 0%, #2c3e50 100%);">
                    <h3>Ukupna statistika sta≈æa</h3>
                    <div class="details-grid">
                        <div class="detail-item">
                            <div class="label">Ukupan sta≈æ</div>
                            <div class="value">${statistika.ukupno.godine} god ${statistika.ukupno.meseci} mes ${statistika.ukupno.dani} dan</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Efektivni sta≈æ (bez beneficiranja)</div>
                            <div class="value">${statistika.efektivni.godine} god ${statistika.efektivni.meseci} mes ${statistika.efektivni.dani} dan</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Beneficirani sta≈æ (pre obraƒçuna)</div>
                            <div class="value">${statistika.beneficiraniPre.godine} god ${statistika.beneficiraniPre.meseci} mes ${statistika.beneficiraniPre.dani} dan</div>
                        </div>
                        <div class="detail-item">
                            <div class="label">Beneficirani sta≈æ (posle obraƒçuna)</div>
                            <div class="value">${statistika.beneficiraniPosle.godine} god ${statistika.beneficiraniPosle.meseci} mes ${statistika.beneficiraniPosle.dani} dan</div>
                        </div>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3>Pregled po tipu beneficiranja</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Tip beneficiranja</th>
                                    <th>Koeficijent</th>
                                    <th>Broj godina</th>
                                    <th>Meseci pre obraƒçuna</th>
                                    <th>Meseci posle obraƒçuna</th>
                                    <th>Ukupni doprinos</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            statistika.poTipu.forEach(tip => {
                html += `
                    <tr>
                        <td>${tip.naziv}</td>
                        <td>${tip.koeficijent}</td>
                        <td>${tip.brojGodina}</td>
                        <td>${tip.meseciPre.toFixed(1)}</td>
                        <td>${tip.meseciPosle.toFixed(1)}</td>
                        <td>${tip.doprinosGodine.toFixed(2)} god</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card" style="margin-top: 20px;">
                    <h3>Detaljan pregled po godinama</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Godina</th>
                                    <th>Efektivni meseci</th>
                                    <th>Efektivni dani</th>
                                    <th>Beneficirani meseci</th>
                                    <th>Beneficirani dani</th>
                                    <th>Tip beneficiranja</th>
                                    <th>Koeficijent</th>
                                    <th>Doprinos (godine)</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            statistika.poGodini.forEach(godina => {
                html += `
                    <tr>
                        <td>${godina.godina}</td>
                        <td>${godina.efektivniMeseci}</td>
                        <td>${godina.efektivniDani}</td>
                        <td>${godina.beneficiraniMeseci}</td>
                        <td>${godina.beneficiraniDani}</td>
                        <td>${godina.tipNaziv}</td>
                        <td>${godina.koeficijent}</td>
                        <td>${godina.doprinos.toFixed(4)}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="action-buttons" style="margin-top: 20px;">
                    <button class="btn btn-success" id="eksportStatistikeExcel">
                        üìä Export statistike u Excel
                    </button>
                </div>
            `;
            
            document.getElementById('statistikaContainer').innerHTML = html;
            prikaziUslov23();
            
            if (document.getElementById('eksportStatistikeExcel')) {
                document.getElementById('eksportStatistikeExcel').addEventListener('click', eksportStatistikeExcel);
            }
        }
        
        function eksportStatistikeExcel() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            const statistika = izracunajStatistikuStaza();
            
            const wb = XLSX.utils.book_new();
            
            const summaryData = [
                ['Statistika sta≈æa za:', korisnik.ime],
                ['Datum izve≈°taja:', new Date().toLocaleDateString('sr-RS')],
                [],
                ['UKUPNI STA≈Ω', 'Godine', 'Meseci', 'Dani'],
                ['Ukupan sta≈æ', statistika.ukupno.godine, statistika.ukupno.meseci, statistika.ukupno.dani],
                ['Efektivni sta≈æ (bez beneficiranja)', statistika.efektivni.godine, statistika.efektivni.meseci, statistika.efektivni.dani],
                ['Beneficirani sta≈æ (pre obraƒçuna)', statistika.beneficiraniPre.godine, statistika.beneficiraniPre.meseci, statistika.beneficiraniPre.dani],
                ['Beneficirani sta≈æ (posle obraƒçuna)', statistika.beneficiraniPosle.godine, statistika.beneficiraniPosle.meseci, statistika.beneficiraniPosle.dani]
            ];
            
            statistika.poTipu.forEach(tip => {
                summaryData.push([
                    tip.naziv,
                    tip.koeficijent,
                    tip.brojGodina,
                    tip.meseciPre,
                    tip.meseciPosle,
                    tip.doprinosGodine
                ]);
            });
            
            const ws1 = XLSX.utils.aoa_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, "Sumarno");
            
            const detailHeader = [
                ['Detaljan pregled sta≈æa po godinama'],
                [],
                ['Godina', 'Efektivni meseci', 'Efektivni dani', 'Beneficirani meseci', 'Beneficirani dani', 
                 'Tip beneficiranja', 'Koeficijent', 'Doprinos (godine)']
            ];
            
            const detailData = detailHeader.concat(
                statistika.poGodini.map(g => [
                    g.godina,
                    g.efektivniMeseci,
                    g.efektivniDani,
                    g.beneficiraniMeseci,
                    g.beneficiraniDani,
                    g.tipNaziv,
                    g.koeficijent,
                    g.doprinos
                ])
            );
            
            const ws2 = XLSX.utils.aoa_to_sheet(detailData);
            XLSX.utils.book_append_sheet(wb, ws2, "Po godinama");
            
            const filename = `statistika-staza-${korisnik.ime.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            NotificationSystem.show(`Statistika sta≈æa uspe≈°no eksportovana u ${filename}`, 'success');
        }
        
        function prikaziRezultate(rezultat) {
            document.getElementById('penzijaMesecno').textContent = 
                `${formatCurrency(rezultat.penzijaMesecno)}`;
            document.getElementById('penzijaGodisnje').textContent = 
                `${formatCurrency(rezultat.penzija)} godi≈°nje`;
            
            document.getElementById('licniKoeficijent').textContent = rezultat.licniKoeficijent.toFixed(4);
            document.getElementById('koeficijentBolovanja').textContent = rezultat.koeficijentBolovanja.toFixed(4);
            document.getElementById('penzijskiStaz').textContent = rezultat.penzijskiStazGodine.toFixed(2);
            document.getElementById('efektivniStazZaKoeficijent').textContent = rezultat.efektivniStazGodine.toFixed(2);
            document.getElementById('opstiBodPrikaz').textContent = formatCurrency(rezultat.opstiBod, false);
            document.getElementById('brojGodina').textContent = rezultat.brojGodina;
            
            updateDataTables();
            prikaziTabeluBolovanja(rezultat.podaciBolovanje);
        }
        
        function prikaziTabeluBolovanja(podaciBolovanje = null) {
            const tbody = document.getElementById('tabelaBolovanjeBody');
            
            if (!podaciBolovanje && aktivniKorisnikId) {
                const koefBol = izracunajKoeficijentBolovanja();
                podaciBolovanje = koefBol.podaci;
            }
            
            if (!podaciBolovanje || podaciBolovanje.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Nema podataka za period do 2002</td></tr>';
                return;
            }
            
            tbody.innerHTML = '';
            
            let zbirSatiRada = 0;
            let zbirSatiBol = 0;
            let zbirLK = 0;
            
            podaciBolovanje.forEach(podatak => {
                zbirSatiRada += podatak.satiRada;
                zbirSatiBol += podatak.satiBolovanje;
                zbirLK += podatak.godisnjiLK;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${podatak.godina}</td>
                    <td style="text-align: right;">${podatak.satiRada}</td>
                    <td style="text-align: right;">${podatak.satiBolovanje}</td>
                    <td style="text-align: right;">${podatak.godisnjiLK.toFixed(4)}</td>
                    <td style="text-align: right;">${(podatak.satiRada > 0 ? (podatak.satiBolovanje / podatak.satiRada) * podatak.godisnjiLK : 0).toFixed(4)}</td>
                `;
                tbody.appendChild(row);
            });
            
            const zbirRow = document.createElement('tr');
            zbirRow.style.fontWeight = 'bold';
            zbirRow.style.background = '#f8f9fa';
            zbirRow.innerHTML = `
                <td><strong>UKUPNO:</strong></td>
                <td style="text-align: right;"><strong>${zbirSatiRada}</strong></td>
                <td style="text-align: right;"><strong>${zbirSatiBol}</strong></td>
                <td style="text-align: right;"><strong>${zbirLK.toFixed(4)}</strong></td>
                <td style="text-align: right;"><strong>${(zbirSatiRada > 0 ? (zbirSatiBol / zbirSatiRada) * zbirLK : 0).toFixed(4)}</strong></td>
            `;
            tbody.appendChild(zbirRow);
        }
        
        function updateDataTables() {
            if (!aktivniKorisnikId) return;
            
            const korisnik = korisnici[aktivniKorisnikId];
            
            const zaradeContainer = document.getElementById('zaradeEditContainer');
            zaradeContainer.innerHTML = '';
            
            if (korisnik.zarade.length === 0) {
                document.getElementById('emptyZarade').style.display = 'block';
            } else {
                document.getElementById('emptyZarade').style.display = 'none';
                const sortedZarade = [...korisnik.zarade].sort((a, b) => a.godina - b.godina);
                
                sortedZarade.forEach(zarada => {
                    const koeficijent = zarada.licnaZarada / zarada.prosecnaPlata;
                    const ograniceniKoeficijent = Math.max(0.18, Math.min(koeficijent, 5.0));
                    
                    const div = document.createElement('div');
                    div.className = 'edit-row';
                    div.innerHTML = `
                        <input type="number" class="edit-godina" value="${zarada.godina}" min="1990" max="2050">
                        <input type="number" class="edit-licna-zarada" value="${zarada.licnaZarada}" min="0" step="0.01">
                        <input type="number" class="edit-prosecna-plata" value="${zarada.prosecnaPlata}" min="0" step="0.01">
                        <div>${ograniceniKoeficijent.toFixed(4)}</div>
                        <input type="number" class="edit-sati-rada" value="${zarada.satiRada || 0}" min="0" step="1">
                        <input type="number" class="edit-sati-bolovanje" value="${zarada.satiBolovanje || 0}" min="0" step="1">
                        <div class="actions-cell">
                            <button class="btn btn-danger" onclick="obrisiRedZarade(this)">üóëÔ∏è</button>
                        </div>
                    `;
                    zaradeContainer.appendChild(div);
                });
            }
            
            const stazContainer = document.getElementById('stazEditContainer');
            stazContainer.innerHTML = '';
            
            if (korisnik.staz.length === 0) {
                document.getElementById('emptyStaz').style.display = 'block';
            } else {
                document.getElementById('emptyStaz').style.display = 'none';
                const sortedStaz = [...korisnik.staz].sort((a, b) => a.godina - b.godina);
                
                sortedStaz.forEach(staz => {
                    let tipOptions = '';
                    tipoviBeneficiranja.forEach(tip => {
                        const selected = tip.id === staz.tipBeneficiranja ? 'selected' : '';
                        tipOptions += `<option value="${tip.id}" ${selected}>${tip.naziv} (${tip.koeficijent})</option>`;
                    });
                    
                    const div = document.createElement('div');
                    div.className = 'edit-row';
                    div.innerHTML = `
                        <input type="number" class="edit-godina-staz" value="${staz.godina}" min="1990" max="2050">
                        <input type="number" class="edit-meseci" value="${staz.efektivniMeseci}" min="0" max="12" step="1">
                        <input type="number" class="edit-dani" value="${staz.efektivniDani}" min="0" max="30" step="1">
                        <input type="number" class="edit-beneficirani-meseci" value="${staz.beneficiraniMeseci}" min="0" max="12" step="1">
                        <input type="number" class="edit-beneficirani-dani" value="${staz.beneficiraniDani}" min="0" max="30" step="1">
                        <select class="edit-tip-beneficiranja">
                            ${tipOptions}
                        </select>
                        <div class="actions-cell">
                            <button class="btn btn-danger" onclick="obrisiRedStaz(this)">üóëÔ∏è</button>
                        </div>
                    `;
                    stazContainer.appendChild(div);
                });
            }
        }
        
        function updateDisplay() {
            if (aktivniKorisnikId) {
                const rezultat = izracunajPenziju();
                prikaziRezultate(rezultat);
                prikaziUslov23();
            }
        }
        
        function refreshPlateTable() {
            const tbody = document.getElementById('tabelaPlateBody');
            tbody.innerHTML = '';
            
            const sortedYears = Object.keys(prosecnePlate).sort((a, b) => b - a);
            
            sortedYears.forEach(year => {
                const plata = prosecnePlate[year];
                const mesecna = Math.round(plata / 12);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${year}</td>
                    <td class="money">${formatCurrency(plata, false)}</td>
                    <td class="money">${formatCurrency(mesecna, false)}</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" onclick="izmeniPlatu(${year})">‚úèÔ∏è Izmeni</button>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px; background: #e74c3c;" onclick="obrisiPlatu(${year})">üóëÔ∏è Obri≈°i</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function dodajPlatu() {
            const godinaInput = document.getElementById('novaGodina');
            const plataInput = document.getElementById('novaPlata');
            
            const godina = parseInt(godinaInput.value);
            const plata = parseFloat(plataInput.value);
            
            if (!godina || godina < 1990 || godina > 2050) {
                NotificationSystem.show('Unesite validnu godinu (1990-2050)', 'error');
                return;
            }
            
            if (!plata || plata <= 0) {
                NotificationSystem.show('Unesite validnu vrednost za platu', 'error');
                return;
            }
            
            prosecnePlate[godina] = plata;
            saveProsecnePlate();
            refreshPlateTable();
            
            if (aktivniKorisnikId) {
                const korisnik = korisnici[aktivniKorisnikId];
                const index = korisnik.zarade.findIndex(z => z.godina === godina);
                if (index !== -1) {
                    korisnik.zarade[index].prosecnaPlata = plata;
                    saveKorisnici();
                    updateDisplay();
                }
            }
            
            godinaInput.value = '';
            plataInput.value = '';
            NotificationSystem.show(`Proseƒçna plata za ${godina}. godinu uspe≈°no saƒçuvana`, 'success');
        }
        
        function izmeniPlatu(godina) {
            document.getElementById('novaGodina').value = godina;
            document.getElementById('novaPlata').value = prosecnePlate[godina];
            NotificationSystem.show(`Uredite vrednost za ${godina}. godinu i kliknite "Saƒçuvaj"`, 'info');
        }
        
        function obrisiPlatu(godina) {
            if (!confirm(`Da li ste sigurni da ≈æelite da obri≈°ete proseƒçnu platu za ${godina}. godinu?`)) {
                return;
            }
            
            delete prosecnePlate[godina];
            saveProsecnePlate();
            refreshPlateTable();
            NotificationSystem.show(`Proseƒçna plata za ${godina}. godinu je obrisana`, 'success');
        }
        
        function resetujPlate() {
            if (!confirm('Da li ste sigurni da ≈æelite da resetujete sve proseƒçne plate na podrazumevane vrednosti?')) {
                return;
            }
            
            prosecnePlate = {
                "1995": 4116, "1996": 7896, "1997": 9576, "1998": 12624, "1999": 15132,
                "2000": 28668, "2001": 70080, "2002": 110496, "2003": 199344, "2004": 246660,
                "2005": 306168, "2006": 380940, "2007": 464928, "2008": 548088, "2009": 529764,
                "2010": 569400, "2011": 632796, "2012": 689160, "2013": 728496, "2014": 737112,
                "2015": 733740, "2016": 761688, "2017": 791712, "2018": 823548, "2019": 909768,
                "2020": 995808, "2021": 1089408, "2022": 1239792, "2023": 1423188, "2024": 1624836
            };
            
            saveProsecnePlate();
            refreshPlateTable();
            
            NotificationSystem.show('Proseƒçne plate resetovane na podrazumevane vrednosti', 'success');
        }
        
        // NOVA POBOLJ≈†ANA FUNKCIJA ZA EXPORT PODATAKA
        function exportPodatakaPoboljsano() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            const rezultat = izracunajPenziju();
            const statistika = izracunajStatistikuStaza();
            const uslov23 = proveriUslov23();
            
            const wb = XLSX.utils.book_new();
            
            // 1. SHEET: OSNOVNI PODACI I REZULTATI
            const osnovniPodaci = [
                ['KOMPLETAN IZVE≈†TAJ O PENZIJI'],
                ['Penzioni Kalkulator PIO - Srbija'],
                [],
                ['OSNOVNI PODACI KORISNIKA'],
                ['Ime i prezime:', korisnik.ime],
                ['Godina penzionisanja:', korisnik.godinaPenzionisanja],
                ['Op≈°ti bod:', formatCurrency(korisnik.opstiBod, false) + ' din'],
                ['Datum izve≈°taja:', new Date().toLocaleDateString('sr-RS')],
                [],
                ['REZULTATI OBRAƒåUNA'],
                ['Meseƒçna penzija:', formatCurrency(rezultat.penzijaMesecno)],
                ['Godi≈°nja penzija:', formatCurrency(rezultat.penzija)],
                ['Liƒçni koeficijent:', rezultat.licniKoeficijent.toFixed(4)],
                ['Koeficijent bolovanja:', rezultat.koeficijentBolovanja.toFixed(4)],
                ['Penzijski sta≈æ:', rezultat.penzijskiStazGodine.toFixed(2) + ' godina'],
                ['Efektivni sta≈æ (za LK):', rezultat.efektivniStazGodine.toFixed(2) + ' godina'],
                ['Broj godina sa podacima:', rezultat.brojGodina],
                [],
                ['PROVERA USLOVA 2/3'],
                ['Efektivni sta≈æ:', uslov23 ? uslov23.efektivniGodine.toFixed(2) + ' godina' : '0 godina'],
                ['Beneficirani sta≈æ:', uslov23 ? uslov23.beneficiraniGodine.toFixed(2) + ' godina' : '0 godina'],
                ['Zahtevani minimum (2/3):', uslov23 ? uslov23.zahtevaniMinimum.toFixed(2) + ' godina' : '0 godina'],
                ['Ispunjenost uslova:', uslov23 ? (uslov23.procenat.toFixed(1) + '%') : '0%'],
                ['Status:', uslov23 ? uslov23.status : 'NEMA PODATAKA']
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(osnovniPodaci);
            XLSX.utils.book_append_sheet(wb, ws1, "Osnovno");
            
            // 2. SHEET: ZARADE I KOEFICIJENTI
            if (korisnik.zarade.length > 0) {
                const zaradeHeader = [
                    ['ZARADE I LIƒåNI KOEFICIJENTI PO GODINAMA'],
                    [],
                    ['Godina', 'Liƒçna zarada (RSD)', 'Proseƒçna plata (RSD)', 'Godi≈°nji LK', 'Ograniƒçeni LK (0.18-5.0)', 'Sati rada', 'Sati bolovanja']
                ];
                
                const zaradeData = korisnik.zarade.map(z => {
                    const godisnjiLK = z.licnaZarada / z.prosecnaPlata;
                    const ograniceniLK = Math.max(0.18, Math.min(godisnjiLK, 5.0));
                    
                    return [
                        z.godina,
                        z.licnaZarada,
                        z.prosecnaPlata,
                        godisnjiLK.toFixed(4),
                        ograniceniLK.toFixed(4),
                        z.satiRada || 0,
                        z.satiBolovanje || 0
                    ];
                });
                
                // Dodaj sumarne redove
                const sumaZarada = korisnik.zarade.reduce((sum, z) => sum + z.licnaZarada, 0);
                const sumaProsecnih = korisnik.zarade.reduce((sum, z) => sum + z.prosecnaPlata, 0);
                const sumaSatiRada = korisnik.zarade.reduce((sum, z) => sum + (z.satiRada || 0), 0);
                const sumaSatiBol = korisnik.zarade.reduce((sum, z) => sum + (z.satiBolovanje || 0), 0);
                
                const zaradeSuma = [
                    [],
                    ['UKUPNO:', sumaZarada, sumaProsecnih, '', '', sumaSatiRada, sumaSatiBol]
                ];
                
                const zaradeComplete = zaradeHeader.concat(zaradeData).concat(zaradeSuma);
                const ws2 = XLSX.utils.aoa_to_sheet(zaradeComplete);
                XLSX.utils.book_append_sheet(wb, ws2, "Zarade");
            }
            
            // 3. SHEET: STA≈Ω PO GODINAMA
            if (korisnik.staz.length > 0) {
                const stazHeader = [
                    ['STA≈Ω PO GODINAMA SA BENEFICIRANJEM'],
                    [],
                    ['Godina', 'Efektivni meseci', 'Efektivni dani', 'Benef. meseci', 'Benef. dani', 
                     'Tip beneficiranja', 'Koeficijent', 'Doprinos meseci']
                ];
                
                const stazData = korisnik.staz.map(s => {
                    const tipInfo = tipoviBeneficiranja.find(t => t.id === s.tipBeneficiranja);
                    const koeficijent = tipInfo ? tipInfo.koeficijent : 0.3333;
                    const doprinosMeseci = (s.beneficiraniMeseci + (s.beneficiraniDani / 30)) * koeficijent;
                    
                    return [
                        s.godina,
                        s.efektivniMeseci,
                        s.efektivniDani,
                        s.beneficiraniMeseci,
                        s.beneficiraniDani,
                        tipInfo ? tipInfo.naziv : 'Standardno',
                        koeficijent,
                        doprinosMeseci.toFixed(2)
                    ];
                });
                
                // Suma
                const sumaEfektivniMeseci = korisnik.staz.reduce((sum, s) => sum + s.efektivniMeseci, 0);
                const sumaEfektivniDani = korisnik.staz.reduce((sum, s) => sum + s.efektivniDani, 0);
                const sumaBenefMeseci = korisnik.staz.reduce((sum, s) => sum + s.beneficiraniMeseci, 0);
                const sumaBenefDani = korisnik.staz.reduce((sum, s) => sum + s.beneficiraniDani, 0);
                
                const ukupniEfektivni = sumaEfektivniMeseci + (sumaEfektivniDani / 30);
                const ukupniBenefPre = sumaBenefMeseci + (sumaBenefDani / 30);
                
                let ukupniDoprinos = 0;
                korisnik.staz.forEach(s => {
                    const tipInfo = tipoviBeneficiranja.find(t => t.id === s.tipBeneficiranja);
                    const koeficijent = tipInfo ? tipInfo.koeficijent : 0.3333;
                    ukupniDoprinos += (s.beneficiraniMeseci + (s.beneficiraniDani / 30)) * koeficijent;
                });
                
                const stazSuma = [
                    [],
                    ['UKUPNO:', 
                     sumaEfektivniMeseci, 
                     sumaEfektivniDani, 
                     sumaBenefMeseci, 
                     sumaBenefDani, 
                     '', 
                     '', 
                     ukupniDoprinos.toFixed(2)],
                    ['UKUPNO u godinama:', 
                     '', 
                     '', 
                     '', 
                     '', 
                     '', 
                     '', 
                     ''],
                    ['Efektivni sta≈æ:', (ukupniEfektivni / 12).toFixed(2) + ' godina'],
                    ['Beneficirani sta≈æ (pre):', (ukupniBenefPre / 12).toFixed(2) + ' godina'],
                    ['Doprinos beneficije:', (ukupniDoprinos / 12).toFixed(2) + ' godina'],
                    ['Ukupan penzijski sta≈æ:', ((ukupniEfektivni + ukupniDoprinos) / 12).toFixed(2) + ' godina']
                ];
                
                const stazComplete = stazHeader.concat(stazData).concat(stazSuma);
                const ws3 = XLSX.utils.aoa_to_sheet(stazComplete);
                XLSX.utils.book_append_sheet(wb, ws3, "Staz");
            }
            
            // 4. SHEET: STATISTIKA
            const statistikaData = [
                ['DETALJNA STATISTIKA STA≈ΩA'],
                [],
                ['UKUPNI STA≈Ω', 'Godine', 'Meseci', 'Dani'],
                ['Ukupan sta≈æ', statistika.ukupno.godine, statistika.ukupno.meseci, statistika.ukupno.dani],
                ['Efektivni sta≈æ', statistika.efektivni.godine, statistika.efektivni.meseci, statistika.efektivni.dani],
                ['Beneficirani sta≈æ (pre obraƒçuna)', statistika.beneficiraniPre.godine, statistika.beneficiraniPre.meseci, statistika.beneficiraniPre.dani],
                ['Beneficirani sta≈æ (posle obraƒçuna)', statistika.beneficiraniPosle.godine, statistika.beneficiraniPosle.meseci, statistika.beneficiraniPosle.dani]
            ];
            
            statistika.poTipu.forEach(tip => {
                statistikaData.push([
                    tip.naziv,
                    tip.koeficijent,
                    tip.brojGodina,
                    tip.meseciPre,
                    tip.meseciPosle,
                    tip.doprinosGodine
                ]);
            });
            
            const ws4 = XLSX.utils.aoa_to_sheet(statistikaData);
            XLSX.utils.book_append_sheet(wb, ws4, "Statistika");
            
            // 5. SHEET: KOEFICIJENT BOLOVANJA
            const koefBol = izracunajKoeficijentBolovanja();
            if (koefBol.podaci.length > 0) {
                const bolovanjeHeader = [
                    ['KOEFICIJENT BOLOVANJA (period do 2002)'],
                    ['Godina', 'Sati rada', 'Sati bolovanja', 'Godi≈°nji LK', 'Doprinos']
                ];
                
                const bolovanjeData = koefBol.podaci.map(p => [
                    p.godina,
                    p.satiRada,
                    p.satiBolovanje,
                    p.godisnjiLK.toFixed(4),
                    p.doprinos.toFixed(4)
                ]);
                
                const bolovanjeSuma = [
                    [],
                    ['UKUPNO:', koefBol.zbirSatiRada, koefBol.zbirSatiBol, koefBol.zbirLK.toFixed(4), koefBol.koeficijent.toFixed(4)],
                    [],
                    ['KOEFICIJENT BOLOVANJA:', koefBol.koeficijent.toFixed(4)]
                ];
                
                const bolovanjeComplete = bolovanjeHeader.concat(bolovanjeData).concat(bolovanjeSuma);
                const ws5 = XLSX.utils.aoa_to_sheet(bolovanjeComplete);
                XLSX.utils.book_append_sheet(wb, ws5, "Bolovanje");
            }
            
            // Saƒçuvaj fajl
            const filename = `penzija-izvestaj-${korisnik.ime.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            NotificationSystem.show(`Kompletan Excel izve≈°taj sa tabelama uspe≈°no generisan: ${filename}`, 'success');
        }
        
        // POBOLJ≈†ANA FUNKCIJA ZA EXPORT POJEDINAƒåNOG KORISNIKA
        function exportPodatakaKorisnikaPoboljsano(korisnikId) {
            const korisnik = korisnici[korisnikId];
            const originalAktivni = aktivniKorisnikId;
            
            // Privremeno postavi ovog korisnika kao aktivnog za izraƒçune
            aktivniKorisnikId = korisnikId;
            
            const rezultat = izracunajPenziju();
            const statistika = izracunajStatistikuStaza();
            const uslov23 = proveriUslov23();
            
            const wb = XLSX.utils.book_new();
            
            // 1. SHEET: OSNOVNI PODACI
            const osnovniPodaci = [
                ['IZVE≈†TAJ O PENZIJI ZA KORISNIKA'],
                [`${korisnik.ime}`],
                ['Datum izve≈°taja:', new Date().toLocaleDateString('sr-RS')],
                [],
                ['OSNOVNE INFORMACIJE'],
                ['Godina penzionisanja:', korisnik.godinaPenzionisanja],
                ['Op≈°ti bod:', formatCurrency(korisnik.opstiBod, false) + ' din'],
                ['Datum kreiranja:', new Date(korisnik.datumKreiranja).toLocaleDateString('sr-RS')],
                ['Datum a≈æuriranja:', new Date(korisnik.datumAzuriranja).toLocaleDateString('sr-RS')],
                [],
                ['REZULTATI OBRAƒåUNA'],
                ['Meseƒçna penzija:', formatCurrency(rezultat.penzijaMesecno)],
                ['Godi≈°nja penzija:', formatCurrency(rezultat.penzija)],
                ['Liƒçni koeficijent:', rezultat.licniKoeficijent.toFixed(4)],
                ['Koeficijent bolovanja:', rezultat.koeficijentBolovanja.toFixed(4)],
                ['Penzijski sta≈æ:', rezultat.penzijskiStazGodine.toFixed(2) + ' godina'],
                ['Efektivni sta≈æ (za LK):', rezultat.efektivniStazGodine.toFixed(2) + ' godina'],
                [],
                ['PROVERA USLOVA 2/3'],
                ['Efektivni sta≈æ:', uslov23 ? uslov23.efektivniGodine.toFixed(2) + ' godina' : '0 godina'],
                ['Beneficirani sta≈æ:', uslov23 ? uslov23.beneficiraniGodine.toFixed(2) + ' godina' : '0 godina'],
                ['Status:', uslov23 ? uslov23.status : 'NEMA PODATAKA']
            ];
            
            const ws1 = XLSX.utils.aoa_to_sheet(osnovniPodaci);
            XLSX.utils.book_append_sheet(wb, ws1, "Osnovno");
            
            // 2. SHEET: ZARADE
            if (korisnik.zarade.length > 0) {
                const zaradeData = [
                    ['ZARADE I KOEFICIJENTI'],
                    ['Godina', 'Liƒçna zarada', 'Proseƒçna plata', 'Godi≈°nji LK', 'Ograniƒçeni LK (0.18-5.0)']
                ];
                
                let sumaGodisnjihLK = 0;
                let sumaOgranicenihLK = 0;
                
                korisnik.zarade.forEach(z => {
                    const godisnjiLK = z.licnaZarada / z.prosecnaPlata;
                    const ograniceniLK = Math.max(0.18, Math.min(godisnjiLK, 5.0));
                    
                    sumaGodisnjihLK += godisnjiLK;
                    sumaOgranicenihLK += ograniceniLK;
                    
                    zaradeData.push([
                        z.godina,
                        z.licnaZarada,
                        z.prosecnaPlata,
                        godisnjiLK.toFixed(4),
                        ograniceniLK.toFixed(4)
                    ]);
                });
                
                // Suma
                zaradeData.push([]);
                zaradeData.push(['PROSEK:', '', '', 
                    (sumaGodisnjihLK / korisnik.zarade.length).toFixed(4),
                    (sumaOgranicenihLK / korisnik.zarade.length).toFixed(4)]);
                
                const ws2 = XLSX.utils.aoa_to_sheet(zaradeData);
                XLSX.utils.book_append_sheet(wb, ws2, "Zarade");
            }
            
            // 3. SHEET: STA≈Ω
            if (korisnik.staz.length > 0) {
                const stazData = [
                    ['STA≈Ω PO GODINAMA'],
                    ['Godina', 'Efektivni meseci', 'Efektivni dani', 'Benef. meseci', 'Benef. dani', 'Tip', 'Koeficijent', 'Doprinos (meseci)']
                ];
                
                let ukupniEfektivni = 0;
                let ukupniBeneficirani = 0;
                let ukupniDoprinos = 0;
                
                korisnik.staz.forEach(s => {
                    const efektivni = s.efektivniMeseci + (s.efektivniDani / 30);
                    const beneficirani = s.beneficiraniMeseci + (s.beneficiraniDani / 30);
                    
                    const tipInfo = tipoviBeneficiranja.find(t => t.id === s.tipBeneficiranja);
                    const koeficijent = tipInfo ? tipInfo.koeficijent : 0.3333;
                    const doprinos = beneficirani * koeficijent;
                    
                    ukupniEfektivni += efektivni;
                    ukupniBeneficirani += beneficirani;
                    ukupniDoprinos += doprinos;
                    
                    stazData.push([
                        s.godina,
                        s.efektivniMeseci,
                        s.efektivniDani,
                        s.beneficiraniMeseci,
                        s.beneficiraniDani,
                        tipInfo ? tipInfo.naziv : 'Standardno',
                        koeficijent,
                        doprinos.toFixed(2)
                    ]);
                });
                
                // Suma
                stazData.push([]);
                stazData.push(['UKUPNO (u mesecima):', 
                    '', '', '', '', '',
                    'Efektivni:', ukupniEfektivni.toFixed(2)]);
                stazData.push(['', '', '', '', '', '',
                    'Beneficirani (pre):', ukupniBeneficirani.toFixed(2)]);
                stazData.push(['', '', '', '', '', '',
                    'Doprinos (posle):', ukupniDoprinos.toFixed(2)]);
                stazData.push(['', '', '', '', '', '',
                    'Ukupni penzijski:', (ukupniEfektivni + ukupniDoprinos).toFixed(2)]);
                
                const ws3 = XLSX.utils.aoa_to_sheet(stazData);
                XLSX.utils.book_append_sheet(wb, ws3, "Staz");
            }
            
            // Vrati originalnog aktivnog korisnika
            aktivniKorisnikId = originalAktivni;
            
            const filename = `penzija-korisnik-${korisnik.ime.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            
            NotificationSystem.show(`Excel izve≈°taj za korisnika "${korisnik.ime}" uspe≈°no generisan`, 'success');
        }
        
        function proveriUslov23() {
            if (!aktivniKorisnikId) {
                return null;
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            if (!korisnik.staz || korisnik.staz.length === 0) {
                return null;
            }
            
            let ukupnoEfektivniMeseci = 0;
            let ukupnoBeneficiraniMeseci = 0;
            
            korisnik.staz.forEach(s => {
                // Pretvori u mesece
                const efektivni = s.efektivniMeseci + (s.efektivniDani / 30);
                const beneficirani = s.beneficiraniMeseci + (s.beneficiraniDani / 30);
                
                ukupnoEfektivniMeseci += efektivni;
                ukupnoBeneficiraniMeseci += beneficirani;
            });
            
            // Pretvori u godine za prikaz
            const efektivniGodine = ukupnoEfektivniMeseci / 12;
            const beneficiraniGodine = ukupnoBeneficiraniMeseci / 12;
            const zahtevaniMinimum = efektivniGodine * (2/3);
            
            // Proveri da li je ispunjeno
            const ispunjeno = beneficiraniGodine >= zahtevaniMinimum;
            const procenat = efektivniGodine > 0 ? (beneficiraniGodine / efektivniGodine) * 100 : 0;
            
            return {
                ispunjeno: ispunjeno,
                procenat: procenat,
                efektivniGodine: efektivniGodine,
                beneficiraniGodine: beneficiraniGodine,
                zahtevaniMinimum: zahtevaniMinimum,
                status: ispunjeno ? "USLOV ISPU–äEN" : "USLOV NIJE ISPU–äEN",
                poruka: ispunjeno 
                    ? "‚úÖ Beneficirani sta≈æ je veƒái ili jednak 2/3 efektivnog sta≈æa." 
                    : "‚ö†Ô∏è Beneficirani sta≈æ nije jednak 2/3 efektivnog sta≈æa."
            };
        }
        
        function prikaziUslov23() {
            const uslov = proveriUslov23();
            const container = document.getElementById('uslov23Container');
            const statistikaContainer = document.getElementById('statistikaUslovContainer');
            
            if (!uslov) {
                container.style.display = 'none';
                if (statistikaContainer) statistikaContainer.style.display = 'none';
                return;
            }
            
            // Prikaz u Calculation tabu
            container.style.display = 'block';
            
            const statusDiv = document.getElementById('uslov23Status');
            statusDiv.className = uslov.ispunjeno ? 'uslov-check uslov-ispunjen' : 'uslov-check uslov-neispunjen';
            statusDiv.textContent = uslov.status + " - " + uslov.poruka;
            
            document.getElementById('uslovEfektivni').textContent = uslov.efektivniGodine.toFixed(2) + " godina";
            document.getElementById('uslovBeneficirani').textContent = uslov.beneficiraniGodine.toFixed(2) + " godina";
            document.getElementById('uslovMinimum').textContent = uslov.zahtevaniMinimum.toFixed(2) + " godina";
            document.getElementById('uslovProcenat').textContent = uslov.procenat.toFixed(1) + "%";
            
            // Progress bar
            const progressFill = document.getElementById('uslovProgress');
            const progressWidth = Math.min(uslov.procenat, 100);
            progressFill.style.width = progressWidth + '%';
            
            // Prikaz u Statistika tabu
            if (statistikaContainer) {
                statistikaContainer.style.display = 'block';
                statistikaContainer.innerHTML = `
                    <div class="card">
                        <h3>üîç Provera uslova 2/3 za beneficirani sta≈æ</h3>
                        <div class="${uslov.ispunjeno ? 'uslov-check uslov-ispunjen' : 'uslov-check uslov-neispunjen'}">
                            ${uslov.status} - ${uslov.poruka}
                        </div>
                        <div class="details-grid">
                            <div class="detail-item">
                                <div class="label">Ukupan efektivni sta≈æ</div>
                                <div class="value">${uslov.efektivniGodine.toFixed(2)} godina</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Ukupan beneficirani sta≈æ</div>
                                <div class="value">${uslov.beneficiraniGodine.toFixed(2)} godina</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Zahtevani minimum (2/3)</div>
                                <div class="value">${uslov.zahtevaniMinimum.toFixed(2)} godina</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Ispunjenost uslova</div>
                                <div class="value">${uslov.procenat.toFixed(1)}%</div>
                            </div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressWidth}%"></div>
                        </div>
                    </div>
                `;
            }
        }
        
        // ====================
        // NOVE FUNKCIJE ZA PDF DROPDOWN
        // ====================
        
        async function generisiKompletanPDF() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            NotificationSystem.show('Generi≈°em kompletan PDF izve≈°taj...', 'info');
            
            try {
                let yPos = 20;
                const pageWidth = pdf.internal.pageSize.getWidth();
                const margin = 20;
                const contentWidth = pageWidth - 2 * margin;
                
                // Naslovna strana
                pdf.setFontSize(22);
                pdf.setTextColor(44, 62, 80);
                pdf.text("KOMPLETAN IZVE≈†TAJ O PENZIJI", pageWidth / 2, yPos, { align: 'center' });
                
                pdf.setFontSize(16);
                pdf.setTextColor(52, 152, 219);
                yPos += 15;
                pdf.text("Penzioni Kalkulator PIO - Srbija", pageWidth / 2, yPos, { align: 'center' });
                
                pdf.setFontSize(14);
                pdf.setTextColor(0, 0, 0);
                yPos += 20;
                pdf.text(`Korisnik: ${korisnik.ime}`, margin, yPos);
                yPos += 10;
                pdf.text(`Datum izve≈°taja: ${new Date().toLocaleDateString('sr-RS')}`, margin, yPos);
                yPos += 10;
                pdf.text(`Godina penzionisanja: ${korisnik.godinaPenzionisanja}`, margin, yPos);
                yPos += 10;
                pdf.text(`Op≈°ti bod: ${formatCurrency(korisnik.opstiBod, false)} din`, margin, yPos);
                
                // Dodaj prazan prostor
                yPos += 20;
                
                // Rezultati obraƒçuna
                const rezultat = izracunajPenziju();
                pdf.setFontSize(18);
                pdf.setTextColor(44, 62, 80);
                pdf.text("REZULTATI OBRAƒåUNA PENZIJE", margin, yPos);
                yPos += 15;
                
                pdf.setFontSize(12);
                pdf.text(`Meseƒçna penzija: ${formatCurrency(rezultat.penzijaMesecno)}`, margin, yPos);
                yPos += 8;
                pdf.text(`Godi≈°nja penzija: ${formatCurrency(rezultat.penzija)}`, margin, yPos);
                yPos += 8;
                pdf.text(`Liƒçni koeficijent: ${rezultat.licniKoeficijent.toFixed(4)}`, margin, yPos);
                yPos += 8;
                pdf.text(`Koeficijent bolovanja: ${rezultat.koeficijentBolovanja.toFixed(4)}`, margin, yPos);
                yPos += 8;
                pdf.text(`Penzijski sta≈æ: ${rezultat.penzijskiStazGodine.toFixed(2)} godina`, margin, yPos);
                yPos += 8;
                pdf.text(`Efektivni sta≈æ: ${rezultat.efektivniStazGodine.toFixed(2)} godina`, margin, yPos);
                
                // Dodaj novu stranu za tabele
                pdf.addPage();
                yPos = 20;
                
                // Tabela zarada
                pdf.setFontSize(16);
                pdf.setTextColor(44, 62, 80);
                pdf.text("ZARADE I KOEFICIJENTI PO GODINAMA", margin, yPos);
                yPos += 10;
                
                if (korisnik.zarade.length > 0) {
                    const zaradeHeaders = [['Godina', 'Liƒçna zarada', 'Proseƒçna plata', 'Koeficijent', 'Sati rada', 'Sati bolovanja']];
                    const zaradeData = korisnik.zarade.map(z => [
                        z.godina.toString(),
                        formatCurrency(z.licnaZarada, false),
                        formatCurrency(z.prosecnaPlata, false),
                        (z.licnaZarada / z.prosecnaPlata).toFixed(4),
                        z.satiRada.toString(),
                        z.satiBolovanje.toString()
                    ]);
                    
                    // KORI≈†ƒÜENJE autoTable funkcije
                    pdf.autoTable({
                        startY: yPos,
                        head: zaradeHeaders,
                        body: zaradeData,
                        margin: { left: margin, right: margin },
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [52, 152, 219] }
                    });
                    
                    yPos = pdf.lastAutoTable.finalY + 10;
                } else {
                    pdf.setFontSize(10);
                    pdf.text("Nema podataka o zaradama", margin, yPos);
                    yPos += 10;
                }
                
                // Tabela sta≈æa
                if (yPos > 250) {
                    pdf.addPage();
                    yPos = 20;
                }
                
                pdf.setFontSize(16);
                pdf.setTextColor(44, 62, 80);
                pdf.text("STA≈Ω PO GODINAMA", margin, yPos);
                yPos += 10;
                
                if (korisnik.staz.length > 0) {
                    const stazHeaders = [['Godina', 'Efektivni meseci', 'Efektivni dani', 'Benef. meseci', 'Benef. dani', 'Tip beneficiranja']];
                    const stazData = korisnik.staz.map(s => [
                        s.godina.toString(),
                        s.efektivniMeseci.toString(),
                        s.efektivniDani.toString(),
                        s.beneficiraniMeseci.toString(),
                        s.beneficiraniDani.toString(),
                        s.tipBeneficiranja
                    ]);
                    
                    pdf.autoTable({
                        startY: yPos,
                        head: stazHeaders,
                        body: stazData,
                        margin: { left: margin, right: margin },
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [39, 174, 96] }
                    });
                } else {
                    pdf.setFontSize(10);
                    pdf.text("Nema podataka o sta≈æu", margin, yPos);
                }
                
                // Dodaj stranu sa uslovom 2/3
                pdf.addPage();
                yPos = 20;
                
                const uslov = proveriUslov23();
                if (uslov) {
                    pdf.setFontSize(16);
                    pdf.setTextColor(44, 62, 80);
                    pdf.text("PROVERA USLOVA 2/3", margin, yPos);
                    yPos += 15;
                    
                    pdf.setFontSize(12);
                    pdf.text(`Efektivni sta≈æ: ${uslov.efektivniGodine.toFixed(2)} godina`, margin, yPos);
                    yPos += 8;
                    pdf.text(`Beneficirani sta≈æ: ${uslov.beneficiraniGodine.toFixed(2)} godina`, margin, yPos);
                    yPos += 8;
                    pdf.text(`Zahtevani minimum (2/3): ${uslov.zahtevaniMinimum.toFixed(2)} godina`, margin, yPos);
                    yPos += 8;
                    pdf.text(`Ispunjenost: ${uslov.procenat.toFixed(1)}%`, margin, yPos);
                    yPos += 8;
                    pdf.text(`Status: ${uslov.status}`, margin, yPos);
                }
                
                // Saƒçuvaj PDF
                const filename = `penzija-kompletan-izvestaj-${korisnik.ime.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(filename);
                
                NotificationSystem.show(`Kompletan PDF izve≈°taj uspe≈°no generisan: ${filename}`, 'success');
                
            } catch (error) {
                NotificationSystem.show(`Gre≈°ka pri generisanju PDF: ${error.message}`, 'error');
                console.error('PDF generisanje gre≈°ka:', error);
            }
        }
        
        async function generisiSa≈æetPDF() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            NotificationSystem.show('Generi≈°em sa≈æet PDF izve≈°taj...', 'info');
            
            try {
                let yPos = 20;
                const pageWidth = pdf.internal.pageSize.getWidth();
                const margin = 20;
                
                // Naslov
                pdf.setFontSize(20);
                pdf.setTextColor(44, 62, 80);
                pdf.text("SA≈ΩETAK PENZIJE", pageWidth / 2, yPos, { align: 'center' });
                
                pdf.setFontSize(16);
                pdf.setTextColor(52, 152, 219);
                yPos += 10;
                pdf.text(korisnik.ime, pageWidth / 2, yPos, { align: 'center' });
                
                pdf.setFontSize(12);
                pdf.setTextColor(100, 100, 100);
                yPos += 8;
                pdf.text(`Datum izve≈°taja: ${new Date().toLocaleDateString('sr-RS')}`, pageWidth / 2, yPos, { align: 'center' });
                
                yPos += 20;
                
                // Rezultati
                const rezultat = izracunajPenziju();
                pdf.setFontSize(18);
                pdf.setTextColor(44, 62, 80);
                pdf.text("REZULTATI OBRAƒåUNA", margin, yPos);
                yPos += 15;
                
                // Glavni rezultat
                pdf.setFontSize(28);
                pdf.setTextColor(39, 174, 96);
                pdf.text(formatCurrency(rezultat.penzijaMesecno), pageWidth / 2, yPos, { align: 'center' });
                yPos += 15;
                
                pdf.setFontSize(12);
                pdf.setTextColor(100, 100, 100);
                pdf.text("meseƒçna penzija", pageWidth / 2, yPos, { align: 'center' });
                
                yPos += 20;
                
                // Detalji
                pdf.setFontSize(12);
                pdf.setTextColor(0, 0, 0);
                pdf.text(`Godi≈°nja penzija: ${formatCurrency(rezultat.penzija)}`, margin, yPos);
                yPos += 8;
                pdf.text(`Liƒçni koeficijent: ${rezultat.licniKoeficijent.toFixed(4)}`, margin, yPos);
                yPos += 8;
                pdf.text(`Penzijski sta≈æ: ${rezultat.penzijskiStazGodine.toFixed(2)} godina`, margin, yPos);
                yPos += 8;
                pdf.text(`Godina penzionisanja: ${korisnik.godinaPenzionisanja}`, margin, yPos);
                yPos += 8;
                pdf.text(`Broj godina sa podacima: ${rezultat.brojGodina}`, margin, yPos);
                
                // Dodaj podatke o beneficiranju
                const uslov = proveriUslov23();
                if (uslov) {
                    yPos += 15;
                    pdf.setFontSize(14);
                    pdf.setTextColor(44, 62, 80);
                    pdf.text("USLOV 2/3 ZA BENEFICIRANI STA≈Ω", margin, yPos);
                    yPos += 10;
                    
                    pdf.setFontSize(12);
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`Efektivni sta≈æ: ${uslov.efektivniGodine.toFixed(2)} godina`, margin, yPos);
                    yPos += 6;
                    pdf.text(`Beneficirani sta≈æ: ${uslov.beneficiraniGodine.toFixed(2)} godina`, margin, yPos);
                    yPos += 6;
                    pdf.text(`Status: ${uslov.status}`, margin, yPos);
                }
                
                // Saƒçuvaj PDF
                const filename = `penzija-sazetak-${korisnik.ime.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(filename);
                
                NotificationSystem.show(`Sa≈æet PDF izve≈°taj uspe≈°no generisan: ${filename}`, 'success');
                
            } catch (error) {
                NotificationSystem.show(`Gre≈°ka pri generisanju PDF: ${error.message}`, 'error');
            }
        }
        
        async function generisiPDFZarade() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            NotificationSystem.show('Generi≈°em PDF tabelu zarada...', 'info');
            
            try {
                let yPos = 20;
                const margin = 20;
                
                // Naslov
                pdf.setFontSize(18);
                pdf.setTextColor(44, 62, 80);
                pdf.text("TABELA ZARADA I KOEFICIJENATA", margin, yPos);
                yPos += 10;
                
                pdf.setFontSize(14);
                pdf.setTextColor(52, 152, 219);
                pdf.text(`Korisnik: ${korisnik.ime}`, margin, yPos);
                yPos += 8;
                
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Datum izve≈°taja: ${new Date().toLocaleDateString('sr-RS')}`, margin, yPos);
                yPos += 15;
                
                if (korisnik.zarade.length > 0) {
                    const zaradeHeaders = [['Godina', 'Liƒçna zarada', 'Proseƒçna plata', 'Koeficijent', 'Sati rada', 'Sati bolovanja']];
                    const zaradeData = korisnik.zarade.map(z => [
                        z.godina.toString(),
                        formatCurrency(z.licnaZarada, false),
                        formatCurrency(z.prosecnaPlata, false),
                        (z.licnaZarada / z.prosecnaPlata).toFixed(4),
                        z.satiRada.toString(),
                        z.satiBolovanje.toString()
                    ]);
                    
                    // Dodaj sumu
                    const sumaZarada = korisnik.zarade.reduce((sum, z) => sum + z.licnaZarada, 0);
                    const sumaProsecnih = korisnik.zarade.reduce((sum, z) => sum + z.prosecnaPlata, 0);
                    
                    pdf.autoTable({
                        startY: yPos,
                        head: zaradeHeaders,
                        body: zaradeData,
                        margin: { left: margin, right: margin },
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [52, 152, 219] },
                        foot: [[
                            'UKUPNO', 
                            formatCurrency(sumaZarada, false), 
                            formatCurrency(sumaProsecnih, false), 
                            '', '', ''
                        ]],
                        footStyles: { fillColor: [240, 240, 240] }
                    });
                    
                    // Dodaj proseke
                    const finalY = pdf.lastAutoTable.finalY + 10;
                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    pdf.text(`Proseƒçan koeficijent: ${izracunajLicniKoeficijent().toFixed(4)}`, margin, finalY);
                    
                } else {
                    pdf.setFontSize(12);
                    pdf.text("Nema podataka o zaradama", margin, yPos);
                }
                
                const filename = `penzija-zarade-${korisnik.ime.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(filename);
                
                NotificationSystem.show(`PDF tabela zarada uspe≈°no generisana: ${filename}`, 'success');
                
            } catch (error) {
                NotificationSystem.show(`Gre≈°ka pri generisanju PDF: ${error.message}`, 'error');
            }
        }
        
        async function generisiPDFStaz() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            const korisnik = korisnici[aktivniKorisnikId];
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            
            NotificationSystem.show('Generi≈°em PDF tabelu sta≈æa...', 'info');
            
            try {
                let yPos = 20;
                const margin = 20;
                
                // Naslov
                pdf.setFontSize(18);
                pdf.setTextColor(44, 62, 80);
                pdf.text("TABELA STA≈ΩA", margin, yPos);
                yPos += 10;
                
                pdf.setFontSize(14);
                pdf.setTextColor(52, 152, 219);
                pdf.text(`Korisnik: ${korisnik.ime}`, margin, yPos);
                yPos += 8;
                
                pdf.setFontSize(10);
                pdf.setTextColor(100, 100, 100);
                pdf.text(`Datum izve≈°taja: ${new Date().toLocaleDateString('sr-RS')}`, margin, yPos);
                yPos += 15;
                
                if (korisnik.staz.length > 0) {
                    const stazHeaders = [['Godina', 'Efektivni meseci', 'Efektivni dani', 'Benef. meseci', 'Benef. dani', 'Tip beneficiranja']];
                    const stazData = korisnik.staz.map(s => [
                        s.godina.toString(),
                        s.efektivniMeseci.toString(),
                        s.efektivniDani.toString(),
                        s.beneficiraniMeseci.toString(),
                        s.beneficiraniDani.toString(),
                        s.tipBeneficiranja
                    ]);
                    
                    // Izraƒçunaj sume
                    const statistika = izracunajStatistikuStaza();
                    
                    pdf.autoTable({
                        startY: yPos,
                        head: stazHeaders,
                        body: stazData,
                        margin: { left: margin, right: margin },
                        styles: { fontSize: 8 },
                        headStyles: { fillColor: [39, 174, 96] }
                    });
                    
                    // Dodaj sumarne podatke
                    const finalY = pdf.lastAutoTable.finalY + 10;
                    pdf.setFontSize(10);
                    pdf.setTextColor(0, 0, 0);
                    
                    pdf.text(`Ukupan efektivni sta≈æ: ${statistika.efektivni.godine} god ${statistika.efektivni.meseci} mes ${statistika.efektivni.dani} dan`, margin, finalY);
                    pdf.text(`Ukupan beneficirani sta≈æ: ${statistika.beneficiraniPre.godine} god ${statistika.beneficiraniPre.meseci} mes ${statistika.beneficiraniPre.dani} dan`, margin, finalY + 6);
                    pdf.text(`Penzijski sta≈æ: ${statistika.ukupno.godine} god ${statistika.ukupno.meseci} mes ${statistika.ukupno.dani} dan`, margin, finalY + 12);
                    
                } else {
                    pdf.setFontSize(12);
                    pdf.text("Nema podataka o sta≈æu", margin, yPos);
                }
                
                const filename = `penzija-staz-${korisnik.ime.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(filename);
                
                NotificationSystem.show(`PDF tabela sta≈æa uspe≈°no generisana: ${filename}`, 'success');
                
            } catch (error) {
                NotificationSystem.show(`Gre≈°ka pri generisanju PDF: ${error.message}`, 'error');
            }
        }
        
        // ====================
        // FUNKCIJE ZA PREDVIƒêANJE
        // ====================
        
        function preuzmiStazIzStatistike() {
            if (!aktivniKorisnikId) {
                NotificationSystem.show('Izaberite korisnika prvo', 'error');
                return;
            }
            
            const statistika = izracunajStatistikuStaza();
            
            // Popuni polja u predviƒëanju
            document.getElementById('predvidjanjeEfektivniGodine').value = statistika.efektivni.godine;
            document.getElementById('predvidjanjeEfektivniMeseci').value = statistika.efektivni.meseci;
            document.getElementById('predvidjanjeEfektivniDani').value = statistika.efektivni.dani;
            
            // Koristimo "beneficiraniPre" - sta≈æ pre obraƒçuna koeficijenta
            document.getElementById('predvidjanjeBeneficiraniGodine').value = statistika.beneficiraniPre.godine;
            document.getElementById('predvidjanjeBeneficiraniMeseci').value = statistika.beneficiraniPre.meseci;
            document.getElementById('predvidjanjeBeneficiraniDani').value = statistika.beneficiraniPre.dani;
            
            // Postavi na 12/16 kao default
            document.getElementById('predvidjanjeVrstaBeneficije').value = '12/16';
            
            NotificationSystem.show("‚úì Sta≈æ uspe≈°no preuzet iz statistike", 'success');
        }
        
        function izracunajPredvidjanje() {
            // Sakrij prethodne rezultate
            document.getElementById('predvidjanjeRezultati').style.display = 'none';
            document.getElementById('predvidjanjeUslovDetaljiContainer').style.display = 'none';
            
            // Prikupljanje podataka
            const datumRodjenja = document.getElementById('predvidjanjeDatumRodjenja').value.trim();
            const datumPoslednjegRada = document.getElementById('predvidjanjeDatumPoslednjegRada').value.trim();
            const vrstaBeneficije = document.getElementById('predvidjanjeVrstaBeneficije').value;
            
            // Sta≈æ podaci
            const efektivniGodine = parseInt(document.getElementById('predvidjanjeEfektivniGodine').value) || 0;
            const efektivniMeseci = parseInt(document.getElementById('predvidjanjeEfektivniMeseci').value) || 0;
            const efektivniDani = parseInt(document.getElementById('predvidjanjeEfektivniDani').value) || 0;
            
            const beneficiraniGodine = parseInt(document.getElementById('predvidjanjeBeneficiraniGodine').value) || 0;
            const beneficiraniMeseci = parseInt(document.getElementById('predvidjanjeBeneficiraniMeseci').value) || 0;
            const beneficiraniDani = parseInt(document.getElementById('predvidjanjeBeneficiraniDani').value) || 0;
            
            // Validiraj datume
            const validacijaRodjenja = validateDate(datumRodjenja, "Datum roƒëenja");
            const validacijaPoslednjegRada = validateDate(datumPoslednjegRada, "Datum poslednjeg rada");
            
            if (!validacijaRodjenja.valid) {
                NotificationSystem.show(validacijaRodjenja.message, 'error');
                return;
            }
            
            if (!validacijaPoslednjegRada.valid) {
                NotificationSystem.show(validacijaPoslednjegRada.message, 'error');
                return;
            }
            
            // Proveri da li je unet bar neki sta≈æ
            const ukupniDani = (efektivniGodine * 365 + efektivniMeseci * 30 + efektivniDani) +
                              (beneficiraniGodine * 365 + beneficiraniMeseci * 30 + beneficiraniDani);
            
            if (ukupniDani <= 0) {
                NotificationSystem.show("Unesite bar neki sta≈æ (efektivni ili beneficirani)", 'error');
                return;
            }
            
            // Pripremi podatke
            const podaci = {
                datumRodjenja: datumRodjenja,
                datumPoslednjegRada: datumPoslednjegRada,
                vrstaBeneficije: vrstaBeneficije,
                
                efektivniGodine: efektivniGodine,
                efektivniMeseci: efektivniMeseci,
                efektivniDani: efektivniDani,
                
                beneficiraniGodine: beneficiraniGodine,
                beneficiraniMeseci: beneficiraniMeseci,
                beneficiraniDani: beneficiraniDani
            };
            
            // Prika≈æi loading state
            const btn = document.getElementById('predvidjanjeIzracunajBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner"></span> Raƒçunam...';
            btn.classList.add('btn-loading');
            
            // Izraƒçunaj
            setTimeout(() => {
                const rezultat = izracunajPredvidjanjeMatematika(podaci);
                
                // Vrati dugme u originalno stanje
                btn.innerHTML = originalText;
                btn.classList.remove('btn-loading');
                
                if (rezultat.error) {
                    NotificationSystem.show(rezultat.error, 'error');
                    return;
                }
                
                // Prika≈æi rezultate
                prikaziPredvidjanjeRezultate(rezultat);
                NotificationSystem.show("‚úÖ Predviƒëanje uspe≈°no izraƒçunato!", 'success');
            }, 500);
        }
        
        function izracunajPredvidjanjeMatematika(podaci) {
            // 1. Konvertuj GMD u dane
            const efektivniDani = gmdUDane(
                podaci.efektivniGodine, 
                podaci.efektivniMeseci, 
                podaci.efektivniDani
            );
            
            const beneficiraniDani = gmdUDane(
                podaci.beneficiraniGodine,
                podaci.beneficiraniMeseci,
                podaci.beneficiraniDani
            );
            
            // 2. Izraƒçunaj beneficiju
            const faktor = getFaktorBeneficije(podaci.vrstaBeneficije);
            const beneficijaDani = Math.round(beneficiraniDani * faktor);
            
            // 3. Parse datume
            const datumRodjenja = parseDate(podaci.datumRodjenja);
            const datumPoslednjegRada = parseDate(podaci.datumPoslednjegRada);
            
            if (!datumRodjenja || !datumPoslednjegRada) {
                return { error: "Neispravni datumi" };
            }
            
            // 4. Poƒçetne vrednosti
            let E = efektivniDani;
            let A = beneficiraniDani;
            let B = beneficijaDani;
            
            // 5. Simulacija fiktivnog rada
            let najranijiDatumPenzije = null;
            let ispunjenUslov = "";
            let uslovDetalji = "";
            let uslovTip = "";
            let finalE = 0;
            let finalA = 0;
            let finalB = 0;
            let finalUkupni = 0;
            
            const maxDana = 365 * 50; // 50 godina maksimum
            
            for (let D_f = 0; D_f <= maxDana; D_f++) {
                const trenutniDatum = new Date(datumPoslednjegRada);
                trenutniDatum.setDate(trenutniDatum.getDate() + D_f);
                
                // A≈æuriraj vrednosti za ovaj dan
                if (D_f > 0) {
                    E = efektivniDani + D_f;
                    A = beneficiraniDani + D_f;
                    B = beneficijaDani + Math.round(D_f * faktor);
                }
                
                const godineZivota = (trenutniDatum - datumRodjenja) / (1000 * 60 * 60 * 24 * 365.25);
                const ukupniStazDani = E + B;
                const ukupniStazGodine = ukupniStazDani / 365;
                
                // Izraƒçunaj donju granicu ZA OVAJ DAN
                const celeGodineBeneficije = Math.floor(B / 365);
                const donjaGranica = Math.max(55, 65 - celeGodineBeneficije);
                
                // Uslov 2/3
                const uslov23 = A > (2/3 * E);
                
                // ===== USLOV A: 40g sta≈æa + donja granica + 2/3 =====
                if (uslov23 && ukupniStazGodine >= 40 && godineZivota >= donjaGranica) {
                    najranijiDatumPenzije = trenutniDatum;
                    uslovTip = "A";
                    ispunjenUslov = `Ispunjen USLOV A (40 godina sta≈æa + donja granica + uslov 2/3)`;
                    finalE = E;
                    finalA = A;
                    finalB = B;
                    finalUkupni = ukupniStazDani;
                    
                    // Detalji uslova
                    uslovDetalji = `
                        <div class="uslov-item">
                            <span class="uslov-ispunjen">‚úì 40+ godina sta≈æa:</span> ${ukupniStazGodine.toFixed(2)} godina
                        </div>
                        <div class="uslov-item">
                            <span class="uslov-ispunjen">‚úì Donja granica dostignuta:</span> ${donjaGranica} godina (trenutno ${godineZivota.toFixed(2)} godina)
                        </div>
                        <div class="uslov-item">
                            <span class="uslov-ispunjen">‚úì Uslov 2/3 ispunjen:</span> beneficirani sta≈æ (${formatGMD(daniUGMD(A))}) > 2/3 efektivnog sta≈æa (${formatGMD(daniUGMD(E * 2/3))})
                        </div>
                        <div class="uslov-item">
                            <span class="uslov-neutral">‚óè Cele godine beneficije:</span> ${celeGodineBeneficije} godina
                        </div>
                        <div class="uslov-item">
                            <span class="uslov-neutral">‚óè Donja granica raƒçun:</span> MAX(55, 65 - ${celeGodineBeneficije}) = ${donjaGranica} godina
                        </div>
                    `;
                    break;
                }
                
                // ===== USLOV B: 65g ≈æivota + 40g sta≈æa =====
                if (godineZivota >= 65 && ukupniStazGodine >= 40) {
                    najranijiDatumPenzije = trenutniDatum;
                    uslovTip = "B";
                    ispunjenUslov = `Ispunjen USLOV B (65 godina ≈æivota + 40 godina sta≈æa)`;
                    finalE = E;
                    finalA = A;
                    finalB = B;
                    finalUkupni = ukupniStazDani;
                    
                    uslovDetalji = `
                        <div class="uslov-item">
                            <span class="uslov-ispunjen">‚úì 65+ godina ≈æivota:</span> ${godineZivota.toFixed(2)} godina
                        </div>
                        <div class="uslov-item">
                            <span class="uslov-ispunjen">‚úì 40+ godina sta≈æa:</span> ${ukupniStazGodine.toFixed(2)} godina
                        </div>
                        <div class="uslov-item">
                            <span class="uslov-neutral">‚óè Efektivni sta≈æ:</span> ${formatGMD(daniUGMD(E))}
                        </div>
                        <div class="uslov-item">
                            <span class="uslov-neutral">‚óè Beneficija:</span> ${formatGMD(daniUGMD(B))}
                        </div>
                    `;
                    break;
                }
                
                // ===== USLOV C: 55g ≈æivota + 45g sta≈æa =====
                if (godineZivota >= 55 && ukupniStazGodine >= 45) {
                    najranijiDatumPenzije = trenutniDatum;
                    uslovTip = "C";
                    ispunjenUslov = `Ispunjen USLOV C (55 godina ≈æivota + 45 godina sta≈æa)`;
                    finalE = E;
                    finalA = A;
                    finalB = B;
                    finalUkupni = ukupniStazDani;
                    
                    uslovDetalji = `
                        <div class="uslov-item">
                            <span class="uslov-ispunjen">‚úì 55+ godina ≈æivota:</span> ${godineZivota.toFixed(2)} godina
                        </div>
                        <div class="uslov-item">
                            <span class="uslov-ispunjen">‚úì 45+ godina sta≈æa:</span> ${ukupniStazGodine.toFixed(2)} godina
                        </div>
                        <div class="uslov-item">
                            <span class="uslov-neutral">‚óè Efektivni sta≈æ:</span> ${formatGMD(daniUGMD(E))}
                        </div>
                        <div class="uslov-item">
                            <span class="uslov-neutral">‚óè Beneficija:</span> ${formatGMD(daniUGMD(B))}
                        </div>
                    `;
                    break;
                }
            }
            
            // 6. Pripremi rezultate
            const efektivniGMD = daniUGMD(efektivniDani);
            const beneficiraniGMD = daniUGMD(beneficiraniDani);
            const beneficijaGMD = daniUGMD(beneficijaDani);
            
            // Finalne vrednosti (na dan ispunjenja uslova)
            const finalEfekGMD = daniUGMD(finalE);
            const finalBenefGMD = daniUGMD(finalA);
            const finalBeneficijaGMD = daniUGMD(finalB);
            const finalUkupniGMD = daniUGMD(finalUkupni);
            
            const finalCeleGodine = Math.floor(finalB / 365);
            const finalDonjaGranica = Math.max(55, 65 - finalCeleGodine);
            
            return {
                // Uneti podaci
                datumRodjenja: podaci.datumRodjenja,
                vrstaBeneficije: podaci.vrstaBeneficije,
                datumPoslednjegRada: podaci.datumPoslednjegRada,
                
                // Originalni sta≈æ
                efektivniGodine: podaci.efektivniGodine,
                efektivniMeseci: podaci.efektivniMeseci,
                efektivniDani: podaci.efektivniDani,
                beneficiraniGodine: podaci.beneficiraniGodine,
                beneficiraniMeseci: podaci.beneficiraniMeseci,
                beneficiraniDani: podaci.beneficiraniDani,
                
                // Finalni sta≈æ na dan ispunjenja uslova
                finalEfektivniGMD: finalEfekGMD,
                finalBeneficiraniGMD: finalBenefGMD,
                finalBeneficijaGMD: finalBeneficijaGMD,
                finalUkupniGMD: finalUkupniGMD,
                
                // Finalne vrednosti
                finalCeleGodineBeneficije: finalCeleGodine,
                finalDonjaGranica: finalDonjaGranica,
                finalUkupniStazGodine: finalUkupni / 365,
                
                // Rezultati
                predvidjeniDatum: najranijiDatumPenzije ? formatDate(najranijiDatumPenzije) : "Ne mo≈æe se dostiƒái u narednih 50 godina",
                predvidjeniUslov: ispunjenUslov,
                uslovDetalji: uslovDetalji,
                uslovTip: uslovTip,
                uspesno: najranijiDatumPenzije !== null
            };
        }
        
        function prikaziPredvidjanjeRezultate(rezultat) {
            // Prikaz glavnog datuma
            document.getElementById('predvidjanjePredvidjeniDatum').textContent = rezultat.predvidjeniDatum;
            document.getElementById('predvidjanjePredvidjeniUslov').innerHTML = rezultat.predvidjeniUslov;
            
            // Prikaz detalja
            document.getElementById('predvidjanjeRezDatumRodjenja').textContent = rezultat.datumRodjenja;
            
            // Formatiraj FINALNI sta≈æ za prikaz (na dan ispunjenja uslova)
            const efektivniFormat = formatGMD(
                rezultat.finalEfektivniGMD.godine,
                rezultat.finalEfektivniGMD.meseci,
                rezultat.finalEfektivniGMD.dani
            );
            
            const beneficiraniFormat = formatGMD(
                rezultat.finalBeneficiraniGMD.godine,
                rezultat.finalBeneficiraniGMD.meseci,
                rezultat.finalBeneficiraniGMD.dani
            );
            
            const ukupniFormat = formatGMD(
                rezultat.finalUkupniGMD.godine,
                rezultat.finalUkupniGMD.meseci,
                rezultat.finalUkupniGMD.dani
            );
            
            const beneficijaFormat = formatGMD(
                rezultat.finalBeneficijaGMD.godine,
                rezultat.finalBeneficijaGMD.meseci,
                rezultat.finalBeneficijaGMD.dani
            );
            
            // Prikaz donje granice
            const umanjenje = 65 - rezultat.finalDonjaGranica;
            const donjaGranicaText = umanjenje > 0 ? 
                `${rezultat.finalDonjaGranica} godina (65 - ${umanjenje})` : 
                `${rezultat.finalDonjaGranica} godina (minimum 55)`;
            
            document.getElementById('predvidjanjeRezEfektivniStaz').textContent = efektivniFormat;
            document.getElementById('predvidjanjeRezBeneficiraniStaz').textContent = beneficiraniFormat;
            document.getElementById('predvidjanjeRezVrstaBeneficije').textContent = rezultat.vrstaBeneficije;
            document.getElementById('predvidjanjeRezDatumPoslednjegRada').textContent = rezultat.datumPoslednjegRada;
            document.getElementById('predvidjanjeRezUkupanStaz').textContent = ukupniFormat;
            document.getElementById('predvidjanjeRezBeneficija').textContent = beneficijaFormat;
            document.getElementById('predvidjanjeRezCeleGodineBeneficije').textContent = 
                `${rezultat.finalCeleGodineBeneficije} godine`;
            document.getElementById('predvidjanjeRezDonjaGranica').textContent = donjaGranicaText;
            
            // Prikaz detalja uslova
            if (rezultat.uslovDetalji) {
                document.getElementById('predvidjanjeUslovDetaljiTekst').innerHTML = rezultat.uslovDetalji;
                document.getElementById('predvidjanjeUslovDetaljiContainer').style.display = 'block';
            }
            
            // Prika≈æi rezultate
            document.getElementById('predvidjanjeRezultati').style.display = 'block';
            
            // Skroluj do rezultata
            document.getElementById('predvidjanjeRezultati').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ====================
        // POMOƒÜNE FUNKCIJE ZA PREDVIƒêANJE
        // ====================
        
        function parseDate(str) {
            if (!str) return null;
            const parts = str.split(".");
            if (parts.length !== 3) return null;
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]) - 1;
            const year = parseInt(parts[2]);
            
            // Validacija
            if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
            if (day < 1 || day > 31) return null;
            if (month < 0 || month > 11) return null;
            if (year < 1900 || year > 2100) return null;
            
            const date = new Date(year, month, day);
            if (date.getDate() !== day || date.getMonth() !== month || date.getFullYear() !== year) {
                return null;
            }
            
            return date;
        }
        
        function formatDate(date) {
            if (!date) return "";
            const d = String(date.getDate()).padStart(2,'0');
            const m = String(date.getMonth()+1).padStart(2,'0');
            const y = date.getFullYear();
            return `${d}.${m}.${y}`;
        }
        
        function getFaktorBeneficije(beneficija) {
            switch(beneficija) {
                case "12/14": return 2/12;
                case "12/15": return 3/12;
                case "12/16": return 4/12;
                case "12/18": return 6/12;
                default: return 0;
            }
        }
        
        function validateDate(dateStr, fieldName) {
            if (!/^\d{2}\.\d{2}\.\d{4}$/.test(dateStr)) {
                return { valid: false, message: `${fieldName} mora biti u formatu dd.mm.gggg` };
            }
            
            const parts = dateStr.split('.');
            const day = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const year = parseInt(parts[2]);
            
            const date = new Date(year, month - 1, day);
            if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
                return { valid: false, message: `Neispravan ${fieldName}` };
            }
            
            if (date > new Date()) {
                return { valid: false, message: `${fieldName} ne mo≈æe biti u buduƒánosti` };
            }
            
            return { valid: true, date: date };
        }
        
        function formatDateInput(input) {
            let value = input.value.replace(/[^\d]/g, '');
            if (value.length >= 2) {
                value = value.substring(0, 2) + '.' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '.' + value.substring(5, 9);
            }
            input.value = value;
        }
        
        function gmdUDane(godine, meseci, dani) {
            return (godine * 365) + (meseci * 30) + dani;
        }
        
        function daniUGMD(dani) {
            const godine = Math.floor(dani / 365);
            dani -= godine * 365;
            const meseci = Math.floor(dani / 30);
            dani -= meseci * 30;
            return { godine, meseci, dani: Math.round(dani) };
        }
        
        function formatGMD(godine, meseci, dani) {
            if (godine === 0 && meseci === 0 && dani === 0) return "0d";
            let result = "";
            if (godine > 0) result += `${godine}g `;
            if (meseci > 0) result += `${meseci}m `;
            if (dani > 0) result += `${dani}d`;
            return result.trim();
        }
        
        function formatCurrency(amount, showRSD = true) {
            if (!amount && amount !== 0) return showRSD ? '0 RSD' : '0';
            const formated = new Intl.NumberFormat('sr-RS', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
            
            return showRSD ? `${formated} RSD` : formated;
        }
        
        function saveKorisnici() {
            localStorage.setItem('penzijaKorisnici', JSON.stringify(korisnici));
        }
        
        function saveProsecnePlate() {
            localStorage.setItem('prosecnePlateKalkulator', JSON.stringify(prosecnePlate));
        }
        
        function saveTipoveBeneficiranja() {
            localStorage.setItem('tipoviBeneficiranja', JSON.stringify(tipoviBeneficiranja));
        }
        
        function jeValidnaGodina(godina) {
            if (!godina && godina !== 0) return false;
            if (typeof godina === 'number') return true;
            if (typeof godina === 'string') {
                return godina.trim() !== '' && !isNaN(parseInt(godina));
            }
            return false;
        }
        
        function konvertujGodinu(godina) {
            if (typeof godina === 'number') {
                if (godina < 100) {
                    return godina <= 50 ? 2000 + godina : 1900 + godina;
                }
                return godina;
            }
            
            if (typeof godina === 'string') {
                const broj = parseInt(godina);
                if (isNaN(broj)) return null;
                
                if (godina.length <= 2) {
                    return broj <= 50 ? 2000 + broj : 1900 + broj;
                }
                return broj;
            }
            
            return null;
        }
        
        function parsirajBroj(celija) {
            if (celija === null || celija === undefined || celija === '') return 0;
            if (typeof celija === 'number') return celija;
            if (typeof celija === 'string') {
                const cleaned = celija.trim().replace(/[^\d,\-\.]/g, '');
                if (cleaned.includes(',')) {
                    const parts = cleaned.split(',');
                    let intPart = parts[0].replace(/\./g, '');
                    const decPart = parts[1] || '00';
                    return parseFloat(intPart + '.' + decPart);
                }
                return parseFloat(cleaned) || 0;
            }
            return 0;
        }
        
        // Globalne funkcije za UI
        window.izmeniKorisnika = izmeniKorisnika;
        window.obrisiKorisnika = obrisiKorisnika;
        window.izmeniPlatu = izmeniPlatu;
        window.obrisiPlatu = obrisiPlatu;
        window.obrisiRedZarade = obrisiRedZarade;
        window.obrisiRedStaz = obrisiRedStaz;
        window.exportPodatakaKorisnikaPoboljsano = exportPodatakaKorisnikaPoboljsano;
        window.prikaziStatistikuStaza = prikaziStatistikuStaza;
        window.eksportStatistikeExcel = eksportStatistikeExcel;
        window.switchTab = switchTab;
        
        // Zadr≈æi staru funkciju za backward compatibility
        window.exportPodatakaKorisnika = function(korisnikId) {
            exportPodatakaKorisnikaPoboljsano(korisnikId);
        };
        
        // Zadr≈æi staru funkciju za backward compatibility
        window.exportPodataka = function() {
            exportPodatakaPoboljsano();
        };
        
        // Eksponiraj nove PDF funkcije
        window.generisiKompletanPDF = generisiKompletanPDF;
        window.generisiSa≈æetPDF = generisiSa≈æetPDF;
        window.generisiPDFZarade = generisiPDFZarade;
        window.generisiPDFStaz = generisiPDFStaz;
    </script>
</body>
</html>¬† 
<!-- Registracija service workera -->
¬† <script>
¬†¬†¬† if ('serviceWorker' in navigator) {
¬†¬†¬†¬†¬† navigator.serviceWorker.register('service-worker.js')
¬†¬†¬†¬†¬†¬†¬† .then(() => console.log('Service Worker registrovan'))
¬†¬†¬†¬†¬†¬†¬† .catch(err => console.error('Gre≈°ka u registraciji SW:', err));
¬†¬†¬† }
¬† </script>
</body>
</html>
